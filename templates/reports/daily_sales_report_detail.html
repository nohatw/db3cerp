{% extends 'base.html' %}
{% load static %}
{% load currency %}

{% block title %}<title>{{ report.user.fullname }} - 日報表詳情 - DB3C ERP</title>{% endblock %}

{% block css %}
<style>
    .detail-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .detail-card h4 {
        font-weight: 700;
        color: #495057;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .metric-box {
        text-align: center;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .metric-box .label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 8px;
    }
    
    .metric-box .value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #495057;
    }
    
    .metric-box.revenue .value {
        color: #198754;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    
    .breakdown-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .breakdown-item:hover {
        background: #e9ecef;
    }
    
    .progress-custom {
        height: 8px;
        border-radius: 4px;
        background: #e9ecef;
        margin-top: 8px;
    }
    
    .progress-bar-custom {
        height: 100%;
        border-radius: 4px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s ease;
    }
    
    .rank-display {
        display: inline-flex;
        align-items: center;
        padding: 10px 20px;
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        border-radius: 30px;
        font-weight: 700;
        font-size: 1.2rem;
        color: #000;
        box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-xl">
        <!-- 頁面標題 -->
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h2 class="page-title">
                        <i class="fa fa-user"></i> {{ report.user.fullname }}
                    </h2>
                    <div class="text-muted">
                        {{ report.report_date|date:"Y年m月d日" }} 日報表
                    </div>
                </div>
                <div class="col-auto">
                    <a href="{% url 'reports:daily_list' %}?date={{ report.report_date|date:'Y-m-d' }}" 
                       class="btn btn-secondary">
                        <i class="fa fa-arrow-left"></i> 返回列表
                    </a>
                </div>
            </div>
        </div>

        <!-- 日期導航 -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        {% if has_prev_report %}
                        <a href="{% url 'reports:daily_detail' prev_report_id %}" 
                           class="btn btn-outline-primary">
                            <i class="fa fa-chevron-left"></i> 前一天
                        </a>
                        {% else %}
                        <button class="btn btn-outline-secondary" disabled>
                            <i class="fa fa-chevron-left"></i> 前一天
                        </button>
                        {% endif %}
                    </div>
                    <div class="col text-center">
                        <strong>{{ report.report_date|date:"Y年m月d日" }}</strong>
                    </div>
                    <div class="col-auto">
                        {% if has_next_report %}
                        <a href="{% url 'reports:daily_detail' next_report_id %}" 
                           class="btn btn-outline-primary">
                            後一天 <i class="fa fa-chevron-right"></i>
                        </a>
                        {% else %}
                        <button class="btn btn-outline-secondary" disabled>
                            後一天 <i class="fa fa-chevron-right"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 左側：核心指標 -->
            <div class="col-md-8">
                <!-- 銷售概況 -->
                <div class="detail-card">
                    <h4><i class="fa fa-bar-chart"></i> 銷售概況</h4>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="metric-box revenue">
                                <div class="label">總收入</div>
                                <div class="value">${{ report.total_revenue|currency }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-box">
                                <div class="label">訂單數</div>
                                <div class="value">{{ report.total_orders }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-box">
                                <div class="label">銷售產品</div>
                                <div class="value">{{ report.total_products_sold }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="metric-box">
                                <div class="label">平均訂單金額</div>
                                <div class="value" style="font-size: 1.4rem;">
                                    ${{ avg_order_amount|floatformat:0|currency }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-box">
                                <div class="label">單位產品收入</div>
                                <div class="value" style="font-size: 1.4rem;">
                                    {% if report.total_products_sold > 0 %}
                                    ${{ report.total_revenue|currency }}
                                    {% else %}
                                    $0
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 產品類型分析 -->
                <div class="detail-card">
                    <h4><i class="fa fa-shopping-cart"></i> 產品類型分析</h4>
                    
                    {% for item in product_breakdown %}
                    <div class="breakdown-item">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <strong>{{ item.type }}</strong>
                                <span style="color: #198754; font-weight: 700;">
                                    ${{ item.revenue|currency }} ({{ item.percentage|floatformat:1 }}%)
                                </span>
                            </div>
                            <small class="text-muted">數量：{{ item.quantity }} 件</small>
                            <div class="progress-custom">
                                <div class="progress-bar-custom" 
                                     style="width: {{ item.percentage }}%"></div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center py-3">無產品類型數據</p>
                    {% endfor %}
                </div>

                <!-- 訂單來源分析 -->
                <div class="detail-card">
                    <h4><i class="fa fa-globe"></i> 訂單來源分析</h4>
                    
                    {% for item in order_source_breakdown %}
                    <div class="breakdown-item">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <strong>{{ item.source }}</strong>
                                <span style="color: #198754; font-weight: 700;">
                                    ${{ item.revenue|currency }} ({{ item.percentage|floatformat:1 }}%)
                                </span>
                            </div>
                            <small class="text-muted">訂單：{{ item.orders }} 筆</small>
                            <div class="progress-custom">
                                <div class="progress-bar-custom" 
                                     style="width: {{ item.percentage }}%"></div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center py-3">無訂單來源數據</p>
                    {% endfor %}
                </div>
            </div>

            <!-- 右側：排名與資訊 -->
            <div class="col-md-4">
                <!-- 用戶資訊 -->
                <div class="detail-card">
                    <h4><i class="fa fa-user"></i> 用戶資訊</h4>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">姓名</small>
                        <strong>{{ report.user.fullname }}</strong>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">帳號</small>
                        <strong>{{ report.user.username }}</strong>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">角色</small>
                        <span class="badge bg-primary">
                            {{ report.user.get_role_display }}
                        </span>
                    </div>
                    
                    {% if report.user.company %}
                    <div class="mb-3">
                        <small class="text-muted d-block">公司</small>
                        <strong>{{ report.user.company }}</strong>
                    </div>
                    {% endif %}
                </div>

                <!-- 排名資訊 -->
                <div class="detail-card">
                    <h4><i class="fa fa-trophy"></i> 排名資訊</h4>
                    
                    <div class="text-center mb-4">
                        <small class="text-muted d-block mb-2">總排名</small>
                        <div class="rank-display">
                            <i class="fa fa-star me-2"></i>
                            第 {{ overall_rank }} 名
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <small class="text-muted d-block mb-2">
                            {{ report.user.get_role_display }} 排名
                        </small>
                        <div class="rank-display" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <i class="fa fa-users me-2"></i>
                            第 {{ role_rank }} / {{ role_total_users }} 名
                        </div>
                    </div>
                </div>

                <!-- 當日總覽 -->
                {% if daily_summary %}
                <div class="detail-card">
                    <h4><i class="fa fa-pie-chart"></i> 當日總覽</h4>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">全平台收入</small>
                        <strong style="font-size: 1.2rem; color: #198754;">
                            ${{ daily_summary.total_revenue|currency }}
                        </strong>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">市場佔有率</small>
                        <strong style="font-size: 1.2rem;">
                            {% widthratio report.total_revenue daily_summary.total_revenue 100 %}%
                        </strong>
                        <div class="progress-custom mt-2">
                            <div class="progress-bar-custom" 
                                 style="width: {% widthratio report.total_revenue daily_summary.total_revenue 100 %}%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">總訂單數</small>
                        <strong>{{ daily_summary.total_orders }} 筆</strong>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}