{% extends 'base.html' %}
{% load static %}

{% block title %}<title>刪除庫存 - DB3C ERP</title>{% endblock %}

{% block css %}
<style>
    .delete-card {
        max-width: 700px;
        margin: 0 auto;
    }
    
    .stock-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .info-row:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 600;
        color: #6c757d;
    }
    
    .info-value {
        color: #212529;
        text-align: right;
    }
    
    .qr-preview {
        max-width: 150px;
        border-radius: 8px;
        border: 2px solid #dee2e6;
    }
    
    .warning-box {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .danger-box {
        background: #f8d7da;
        border: 2px solid #dc3545;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-xl">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="card delete-card">
                    <div class="card-header bg-danger text-white">
                        <h3 class="card-title mb-0">
                            <i class="ti ti-alert-triangle"></i>
                            確認刪除庫存
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            您確定要刪除以下庫存嗎？
                        </p>
                        
                        <!-- 庫存資訊 -->
                        <div class="stock-info">
                            <h5 class="mb-3">
                                <i class="ti ti-package"></i> 庫存資訊
                            </h5>
                            
                            <div class="info-row">
                                <span class="info-label">庫存名稱：</span>
                                <span class="info-value"><strong>{{ stock.name }}</strong></span>
                            </div>
                            
                            <div class="info-row">
                                <span class="info-label">產品變體：</span>
                                <span class="info-value">{{ stock.product.name }}</span>
                            </div>
                            
                            <div class="info-row">
                                <span class="info-label">產品類型：</span>
                                <span class="info-value">
                                    {% if is_esimimg %}
                                        <span class="badge bg-primary">圖庫 eSIM</span>
                                    {% else %}
                                        <span class="badge bg-success">{{ stock.product.get_product_type_display }}</span>
                                    {% endif %}
                                </span>
                            </div>
                            
                            {% if stock.code %}
                            <div class="info-row">
                                <span class="info-label">庫存代碼：</span>
                                <span class="info-value"><code>{{ stock.code }}</code></span>
                            </div>
                            {% endif %}
                            
                            <div class="info-row">
                                <span class="info-label">庫存數量：</span>
                                <span class="info-value">
                                    {% if stock.is_used %}
                                        <span class="badge bg-secondary">已使用</span>
                                    {% else %}
                                        <span class="badge bg-success">{{ stock.quantity }}</span>
                                    {% endif %}
                                </span>
                            </div>
                            
                            {% if stock.expire_date %}
                            <div class="info-row">
                                <span class="info-label">過期時間：</span>
                                <span class="info-value">{{ stock.expire_date|date:"Y-m-d H:i" }}</span>
                            </div>
                            {% endif %}
                            
                            {% if stock.qr_img %}
                            <div class="info-row">
                                <span class="info-label">QR 圖片：</span>
                                <span class="info-value">
                                    <img src="{{ stock.qr_img.url }}" alt="QR" class="qr-preview">
                                </span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- 警告訊息 -->
                        {% if has_qr_image %}
                        <div class="warning-box">
                            <h6 class="mb-2">
                                <i class="ti ti-photo-x"></i> 圖片刪除警告
                            </h6>
                            <p class="mb-0">
                                此庫存包含 QR 圖片，刪除後圖片檔案也會一併從伺服器移除。
                            </p>
                        </div>
                        {% endif %}
                        
                        {% if has_related_orders %}
                        <div class="danger-box">
                            <h6 class="mb-2">
                                <i class="ti ti-alert-circle"></i> 關聯訂單警告
                            </h6>
                            <p class="mb-0">
                                此庫存已關聯到 <strong>{{ related_orders_count }}</strong> 筆訂單！
                                刪除後可能影響訂單記錄的完整性。
                            </p>
                        </div>
                        {% endif %}
                        
                        <div class="alert alert-danger">
                            <strong><i class="ti ti-exclamation-circle"></i> 警告：</strong>
                            此操作無法復原！請確認後再執行刪除。
                        </div>
                        
                        <form method="post">
                            {% csrf_token %}
                            <div class="d-flex justify-content-between">
                                <a href="{% url 'products:stock_list' %}" class="btn btn-secondary">
                                    <i class="ti ti-arrow-left"></i> 取消
                                </a>
                                <button type="submit" class="btn btn-danger" id="deleteBtn">
                                    <i class="ti ti-trash"></i> 確定刪除
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scriptcontent %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteBtn = document.getElementById('deleteBtn');
    
    deleteBtn.addEventListener('click', function(e) {
        const confirmed = confirm('⚠️ 最後確認：您確定要刪除此庫存嗎？');
        if (!confirmed) {
            e.preventDefault();
            return false;
        }
        
        // 禁用按鈕防止重複提交
        setTimeout(function() {
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>刪除中...';
        }, 50);
    });
    
    console.log('✅ 庫存刪除頁面載入完成');
});
</script>
{% endblock %}