{% extends 'base.html' %}
{% load static %} 
{% load humanize %}
{% load currency %}
{% block css %}
<style>
    /* ç”¢å“è©³æƒ…å®¹å™¨ */
    .product-detail-container {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    /* ç”¢å“åœ–ç‰‡å€åŸŸ */
    .product-image-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 60px 40px;
        text-align: center;
        position: relative;
    }
    
    .product-image-section i {
        font-size: 60px;
        color: rgba(255,255,255,0.9);
    }
    
    .product-image-section img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 8px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    
    .product-category-badge {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255,255,255,0.95);
        color: #667eea;
        padding: 4px 8px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
    }
    
    /* ç”¢å“è³‡è¨Šå€åŸŸ */
    .product-info-section {
        padding: 40px;
    }
    
    .product-title {
        font-size: 32px;
        font-weight: 700;
        color: #333;
        margin-bottom: 20px;
    }
    
    .product-description {
        color: #666;
        font-size: 16px;
        line-height: 1.8;
        margin-bottom: 30px;
        padding-bottom: 30px;
        border-bottom: 1px solid #eee;
    }
    
    /* è®Šé«”é¸æ“‡å€åŸŸ */
    .variants-section {
        margin-bottom: 40px;
    }
    
    .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }
    
    .section-title i {
        margin-right: 10px;
        color: #667eea;
    }
    
    .variant-card {
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
    }
    
    .variant-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        transform: translateY(-2px);
    }
    
    .variant-card.selected {
        border-color: #667eea;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    }
    
    .variant-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .variant-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    
    .variant-type-badge {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .variant-type-badge.esim {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .variant-type-badge.esimimg {
        background: #f3e5f5;
        color: #7b1fa2;
    }
    
    .variant-type-badge.rechargeable {
        background: #fff3e0;
        color: #f57c00;
    }
    
    .variant-type-badge.physical {
        background: #e8f5e9;
        color: #388e3c;
    }
    
    .variant-specs {
        display: flex;
        gap: 30px;
        margin-bottom: 15px;
    }
    
    .variant-spec-item {
        display: flex;
        align-items: center;
        color: #666;
        font-size: 14px;
    }
    
    .variant-spec-item i {
        margin-right: 8px;
        color: #667eea;
    }
    
    .variant-prices {
        display: flex;
        gap: 20px;
        align-items: center;
    }
    
    .variant-price {
        font-size: 28px;
        font-weight: 700;
        color: #667eea;
    }
    
    .variant-price-original {
        font-size: 18px;
        color: #999;
        text-decoration: line-through;
    }
    
    .variant-price-label {
        font-size: 12px;
        color: #999;
        display: block;
        margin-bottom: 5px;
    }
    
    .variant-discount-badge {
        background: #ff6b6b;
        color: #fff;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .variant-description {
        color: #666;
        font-size: 14px;
        line-height: 1.6;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    /* é¸ä¸­æ¨™è¨˜ */
    .variant-selected-icon {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 30px;
        height: 30px;
        background: #667eea;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .variant-card.selected .variant-selected-icon {
        opacity: 1;
    }
    
    /* è³¼è²·å€åŸŸ */
    .purchase-section {
        background: #f8f9fa;
        padding: 30px;
        border-radius: 12px;
        position: sticky;
        top: 20px;
    }
    
    .purchase-summary {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .purchase-summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-size: 14px;
    }
    
    .purchase-summary-item:last-child {
        margin-bottom: 0;
        padding-top: 15px;
        border-top: 2px solid #eee;
        font-size: 18px;
        font-weight: 700;
    }
    
    .purchase-total {
        color: #667eea;
        font-size: 28px !important;
    }
    
    .quantity-selector {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
    }
    
    .quantity-btn {
        width: 40px;
        height: 40px;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }
    
    .quantity-btn:hover {
        border-color: #667eea;
        color: #667eea;
    }
    
    .quantity-input {
        width: 80px;
        text-align: center;
        font-size: 18px;
        font-weight: 600;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin: 0 10px;
        padding: 8px;
    }
    
    .btn-add-cart {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        font-weight: 600;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 10px;
    }
    
    .btn-add-cart:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    }
    
    .btn-add-cart:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-buy-now {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        font-weight: 600;
        border-radius: 8px;
        background: #fff;
        border: 2px solid #667eea;
        color: #667eea;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-buy-now:hover {
        background: #667eea;
        color: #fff;
    }
    
    /* ç›¸é—œç”¢å“ */
    .related-products-section {
        margin-top: 60px;
    }
    
    .related-product-card {
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s;
        cursor: pointer;
        height: 100%;
    }
    
    .related-product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    
    .related-product-image {
        width: 100%;
        height: 150px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 36px;
    }
    
    .related-product-body {
        padding: 15px;
    }
    
    .related-product-name {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .related-product-price {
        font-size: 20px;
        font-weight: 700;
        color: #667eea;
    }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
        .product-image-section {
            padding: 40px 20px;
        }
        
        .product-image-section i {
            font-size: 80px;
        }
        
        .product-info-section {
            padding: 20px;
        }
        
        .product-title {
            font-size: 24px;
        }
        
        .variant-card {
            padding: 15px;
        }
        
        .variant-specs {
            flex-direction: column;
            gap: 10px;
        }
        
        .variant-prices {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .purchase-section {
            position: static;
            margin-top: 30px;
        }
    }
    
    /* æç¤ºè¨Šæ¯ */
    .alert-info {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .alert-info i {
        margin-right: 10px;
        color: #2196f3;
    }
    /* äº¤å‰é¸æ“‡å€åŸŸ */
    .selection-grid {
        display: grid;
        gap: 30px;
        margin-bottom: 30px;
    }
    
    .selection-group {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
    }
    
    .selection-group-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    
    .selection-group-title i {
        margin-right: 8px;
        color: #667eea;
    }
    
    .selection-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .selection-option {
        padding: 10px 20px;
        border: 2px solid #ddd;
        background: #fff;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
        font-weight: 500;
        color: #333;
    }
    
    .selection-option:hover {
        border-color: #667eea;
        color: #667eea;
        transform: translateY(-2px);
    }
    
    .selection-option.selected {
        border-color: #667eea;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .selection-option.disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }
    
    .selection-option.disabled:hover {
        border-color: #ddd;
        color: #333;
        transform: none;
    }
    
    /* é¸ä¸­çš„è®Šé«”è³‡è¨Š */
    .selected-variant-info {
        background: #fff;
        border: 2px solid #667eea;
        border-radius: 12px;
        padding: 25px;
        margin-top: 20px;
        display: none;
    }
    
    .selected-variant-info.show {
        display: block;
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .selected-variant-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #eee;
    }
    
    .selected-variant-name {
        font-size: 20px;
        font-weight: 700;
        color: #333;
    }
    
    .selected-variant-code {
        color: #999;
        font-size: 14px;
    }
    
    .selected-variant-specs {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .selected-variant-spec {
        display: flex;
        align-items: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .selected-variant-spec i {
        margin-right: 10px;
        color: #667eea;
        font-size: 18px;
    }
    
    .selected-variant-spec-value {
        font-weight: 600;
        color: #333;
    }
    
    .selected-variant-prices {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .selected-variant-price-box {
        flex: 1;
        min-width: 200px;
    }
    
    .selected-variant-price-label {
        font-size: 12px;
        color: #999;
        margin-bottom: 5px;
    }
    
    .selected-variant-price-value {
        font-size: 32px;
        font-weight: 700;
        color: #667eea;
    }
    
    .selected-variant-price-original {
        font-size: 18px;
        color: #999;
        text-decoration: line-through;
        margin-left: 10px;
    }
    
    .selected-variant-agent-price {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        padding: 15px 20px;
        border-radius: 8px;
        color: #fff;
    }
    
    .selected-variant-agent-price .selected-variant-price-label {
        color: rgba(255,255,255,0.9);
    }
    
    .selected-variant-agent-price .selected-variant-price-value {
        color: #fff;
    }
</style>
{% endblock %}

{% block title %}
<title>{{ product.name }} - DB3C ERP</title>
{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-fluid">
        <!-- éºµåŒ…å±‘å°èˆª -->
        <div class="row mb-3">
            <div class="col-12">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}"><i class="fa fa-home"></i></a></li>
                    <li class="breadcrumb-item"><a href="{% url 'products:catalogue_list' %}">ç”¢å“ç›®éŒ„</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'products:catalogue_list' %}?category={{ product.category.id }}">{{ product.category.name }}</a></li>
                    <li class="breadcrumb-item active">{{ product.name }}</li>
                </ol>
            </div>
        </div>

        <div class="row">
            <!-- å·¦å´ï¼šç”¢å“è³‡è¨Š -->
            <div class="col-lg-8">
                <div class="product-detail-container">
                    <!-- ç”¢å“åœ–ç‰‡å€åŸŸ -->
                    <div class="product-image-section">
                        <!-- <div class="product-category-badge">
                            <i class="fa fa-tag"></i> {{ product.category.name }}
                        </div> -->
                        {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}">
                        {% else %}
                            <i class="fa fa-image"></i>
                        {% endif %}
                    </div>

                    <!-- ç”¢å“è³‡è¨Šå€åŸŸ -->
                    <div class="product-info-section">
                        <h1 class="product-title">{{ product.name }}</h1>
                        
                        {% if product.description %}
                            <div class="product-description">
                                {{ product.description|linebreaks }}
                            </div>
                        {% endif %}

                        <!-- äº¤å‰é¸æ“‡å€åŸŸ -->
                        <div class="variants-section">
                            <h3 class="section-title">
                                <i class="fa fa-sliders-h"></i>
                                é¸æ“‡æ–¹æ¡ˆé…ç½®
                            </h3>

                            {% if variants %}
                                <div class="alert-info">
                                    <i class="fa fa-info-circle"></i>
                                    è«‹å…ˆé¸æ“‡<strong>æ–¹æ¡ˆå¤©æ•¸</strong>ï¼Œå†é¸æ“‡<strong>æµé‡è¦æ ¼</strong>ï¼Œç³»çµ±å°‡è‡ªå‹•åŒ¹é…å°æ‡‰çš„æ–¹æ¡ˆ
                                </div>

                                <div class="selection-grid">
                                    <!-- å¤©æ•¸é¸æ“‡ -->
                                    <div class="selection-group">
                                        <div class="selection-group-title">
                                            <i class="fa fa-calendar"></i>
                                            æ–¹æ¡ˆå¤©æ•¸
                                        </div>
                                        <div class="selection-options" id="daysOptions">
                                            {% for days in days_options %}
                                                <button type="button" 
                                                        class="selection-option" 
                                                        data-days="{{ days }}"
                                                        onclick="selectDays('{{ days }}')">
                                                    {{ days }}
                                                </button>
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <!-- æµé‡è¦æ ¼é¸æ“‡ -->
                                    <div class="selection-group">
                                        <div class="selection-group-title">
                                            <i class="fa fa-database"></i>
                                            æµé‡è¦æ ¼
                                        </div>
                                        <div class="selection-options" id="dataAmountOptions">
                                            {% for data_amount in data_amount_options %}
                                                <button type="button" 
                                                        class="selection-option disabled" 
                                                        data-data-amount="{{ data_amount }}"
                                                        onclick="selectDataAmount('{{ data_amount }}')">
                                                    {{ data_amount }}
                                                </button>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- é¸ä¸­çš„è®Šé«”è³‡è¨Š -->
                                <div class="selected-variant-info" id="selectedVariantInfo">
                                    <div class="selected-variant-header">
                                        <div>
                                            <div class="selected-variant-name" id="svName"></div>
                                            <div class="selected-variant-code" id="svCode"></div>
                                        </div>
                                        <span class="variant-type-badge" id="svTypeBadge"></span>
                                    </div>

                                    <div class="selected-variant-specs">
                                        <div class="selected-variant-spec">
                                            <i class="fa fa-calendar"></i>
                                            <div>
                                                <div style="font-size: 12px; color: #999;">æ–¹æ¡ˆå¤©æ•¸</div>
                                                <div class="selected-variant-spec-value" id="svDays"></div>
                                            </div>
                                        </div>
                                        <div class="selected-variant-spec">
                                            <i class="fa fa-database"></i>
                                            <div>
                                                <div style="font-size: 12px; color: #999;">æµé‡è¦æ ¼</div>
                                                <div class="selected-variant-spec-value" id="svDataAmount"></div>
                                            </div>
                                        </div>
                                        <div class="selected-variant-spec">
                                            <i class="fa fa-barcode"></i>
                                            <div>
                                                <div style="font-size: 12px; color: #999;">ç”¢å“é¡å‹</div>
                                                <div class="selected-variant-spec-value" id="svType"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="svDescription" style="margin-bottom: 20px; color: #666; font-size: 14px; line-height: 1.6;"></div>

                                    <div class="selected-variant-prices">
                                        <div class="selected-variant-price-box">
                                            <div class="selected-variant-price-label">
                                                {% if is_distributor %}
                                                    ä»£ç†å•†å”®åƒ¹
                                                {% else %}
                                                    å”®åƒ¹
                                                {% endif %}
                                            </div>
                                            <div>
                                                <span class="selected-variant-price-value" id="svPrice">$0</span>
                                                <span class="selected-variant-price-original" id="svPriceOriginal"></span>
                                            </div>
                                        </div>

                                        <!-- åˆ†éŠ·å•†çœ‹åˆ°çš„æ˜¯ä»£ç†å•†åƒ¹æ ¼ï¼Œæ‰€ä»¥ä¸éœ€è¦é¡å¤–é¡¯ç¤º -->
                                        <!-- ç¸½å…¬å¸å’Œä»£ç†å•†ä¹Ÿä¸éœ€è¦çœ‹åˆ°ä»£ç†å•†åƒ¹æ ¼ -->
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fa fa-exclamation-triangle"></i>
                                    ç›®å‰æ²’æœ‰å¯ç”¨çš„æ–¹æ¡ˆè¦æ ¼
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                
            </div>

            <!-- å³å´ï¼šè³¼è²·å€åŸŸ -->
            <div class="col-lg-4">
                <div class="purchase-section">
                    <h4 class="mb-3">
                        <i class="fa fa-shopping-cart"></i> è³¼è²·è³‡è¨Š
                    </h4>

                    <!-- è³¼è²·æ‘˜è¦ -->
                    <div class="purchase-summary">
                        <div class="purchase-summary-item">
                            <span>ç”¢å“åç¨±ï¼š</span>
                            <strong>{{ product.name }}</strong>
                        </div>
                        <div class="purchase-summary-item">
                            <span>é¸æ“‡æ–¹æ¡ˆï¼š</span>
                            <strong id="selectedVariantName">è«‹é¸æ“‡æ–¹æ¡ˆ</strong>
                        </div>
                        <div class="purchase-summary-item">
                            <span>æ•¸é‡ï¼š</span>
                            <strong><span id="selectedQuantity">1</span> ä»¶</strong>
                        </div>
                        <div class="purchase-summary-item">
                            <span>ç¸½è¨ˆï¼š</span>
                            <span class="purchase-total" id="totalPrice">$0</span>
                        </div>
                    </div>

                    <!-- æ•¸é‡é¸æ“‡ -->
                    <div class="quantity-selector">
                        <button type="button" class="quantity-btn" onclick="decreaseQuantity()">
                            <i class="fa fa-minus"></i>
                        </button>
                        <input type="number" class="quantity-input" id="quantityInput" value="1" min="1" max="999" readonly>
                        <button type="button" class="quantity-btn" onclick="increaseQuantity()">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>

                    <!-- è³¼è²·æŒ‰éˆ• -->
                    <button type="button" class="btn-add-cart" id="addToCartBtn" disabled>
                        <i class="fa fa-cart-plus"></i> åŠ å…¥è³¼ç‰©è»Š
                    </button>
                    <button type="button" class="btn-buy-now" id="buyNowBtn" disabled>
                        <i class="fa fa-bolt"></i> ç«‹å³è³¼è²·
                    </button>

                    <!-- æç¤ºè¨Šæ¯ -->
                    <div class="alert-info mt-3" style="font-size: 13px;">
                        <i class="fa fa-shield-alt"></i>
                        <strong>è³¼è²·ä¿éšœï¼š</strong>
                        <ul style="margin: 10px 0 0 20px; padding: 0;">
                            <li>æ­£å“ä¿è­‰</li>
                            <li>7å¤©ç„¡ç†ç”±é€€æ›</li>
                            <li>24å°æ™‚å®¢æœæ”¯æ´</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mb-3">
            <!-- ç›¸é—œç”¢å“ -->
            {% if related_products %}
                <div class="related-products-section">
                    <h3 class="section-title">
                        <i class="fa fa-th"></i>
                        ç›¸é—œç”¢å“æ¨è–¦
                    </h3>
                    <div class="row">
                        {% for related in related_products %}
                            <div class="col-md-4 col-sm-6 mb-3">
                                <div class="related-product-card" onclick="window.location.href='{% url 'products:product_detail' related.pk %}'">
                                    <div class="related-product-image">
                                        {% if related.image %}
                                            <img src="{{ related.image.url }}" alt="{{ related.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <i class="fa fa-image"></i>
                                        {% endif %}
                                    </div>
                                    <div class="related-product-body">
                                        <h5 class="related-product-name">{{ related.name }}</h5>
                                        {% if related.min_price %}
                                            <div class="related-product-price">èµ· ${{ related.min_price|floatformat:0|intcomma }}</div>
                                        {% else %}
                                            <div class="related-product-price" style="font-size: 14px; color: #999;">åƒ¹æ ¼è«‹æ´½å®¢æœ</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scriptcontent %}
<script>
    // è®Šé«”æ˜ å°„è¡¨ï¼ˆå¾å¾Œç«¯å‚³ä¾†ï¼‰
    const variantMap = {{ variant_map_json|safe }};
    
    // ç”¨æˆ¶è§’è‰²
    const userRole = {
        isHeadquarter: {% if is_headquarter %}true{% else %}false{% endif %},
        isAgent: {% if is_agent %}true{% else %}false{% endif %},
        isDistributor: {% if is_distributor %}true{% else %}false{% endif %}
    };
    
    // é¸ä¸­çš„é…ç½®
    let selectedDays = null;
    let selectedDataAmount = null;
    let selectedVariant = null;

    // æ”¹é€²çš„ CSRF token ç²å–æ–¹å¼
    function getCsrfToken() {
        // æ–¹æ³• 1: å¾ cookie ç²å–
        const cookies = document.cookie.split('; ');
        for (let cookie of cookies) {
            const [name, value] = cookie.split('=');
            if (name === 'csrftoken') {
                return decodeURIComponent(value);
            }
        }
        
        // æ–¹æ³• 2: å¾ meta tag ç²å–ï¼ˆå¦‚æœæœ‰ï¼‰
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
            return metaTag.getAttribute('content');
        }
        
        // æ–¹æ³• 3: å¾éš±è—çš„ input ç²å–
        const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfInput) {
            return csrfInput.value;
        }
        
        // æ–¹æ³• 4: å¾ window å°è±¡ç²å–
        if (window.csrfToken) {
            return window.csrfToken;
        }
        
        console.error('âŒ CSRF token not found!');
        return '';
    }

    const csrftoken = getCsrfToken();
    console.log('ğŸ”‘ CSRF Token:', csrftoken ? 'âœ“ Found' : 'âœ— Not Found');
    console.log('ğŸ”‘ CSRF Token Length:', csrftoken ? csrftoken.length : 0);

    // é¸æ“‡å¤©æ•¸
    function selectDays(days) {
        selectedDays = days;
        selectedDataAmount = null;
        selectedVariant = null;

        // æ›´æ–°å¤©æ•¸é¸é …çš„é¸ä¸­ç‹€æ…‹
        document.querySelectorAll('[data-days]').forEach(btn => {
            btn.classList.toggle('selected', btn.dataset.days === days);
        });

        // é‡ç½®æµé‡è¦æ ¼é¸é …
        updateDataAmountOptions();
        
        // éš±è—è®Šé«”è³‡è¨Š
        document.getElementById('selectedVariantInfo').classList.remove('show');
        
        // é‡ç½®è³¼è²·è³‡è¨Š
        resetPurchaseInfo();
    }

    // æ›´æ–°æµé‡è¦æ ¼é¸é …ï¼ˆæ ¹æ“šé¸ä¸­çš„å¤©æ•¸ï¼‰
    function updateDataAmountOptions() {
        const dataAmountBtns = document.querySelectorAll('[data-data-amount]');
        
        dataAmountBtns.forEach(btn => {
            btn.classList.remove('selected');
            
            if (selectedDays) {
                const key = `${selectedDays}|${btn.dataset.dataAmount}`;
                if (variantMap[key]) {
                    btn.classList.remove('disabled');
                } else {
                    btn.classList.add('disabled');
                }
            } else {
                btn.classList.add('disabled');
            }
        });
    }

    // é¸æ“‡æµé‡è¦æ ¼
    function selectDataAmount(dataAmount) {
        if (!selectedDays) {
            alert('è«‹å…ˆé¸æ“‡æ–¹æ¡ˆå¤©æ•¸');
            return;
        }

        const key = `${selectedDays}|${dataAmount}`;
        if (!variantMap[key]) {
            alert('æ­¤çµ„åˆæš«ç„¡å¯ç”¨æ–¹æ¡ˆ');
            return;
        }

        selectedDataAmount = dataAmount;
        selectedVariant = variantMap[key];

        // æ›´æ–°æµé‡è¦æ ¼é¸é …çš„é¸ä¸­ç‹€æ…‹
        document.querySelectorAll('[data-data-amount]').forEach(btn => {
            btn.classList.toggle('selected', btn.dataset.dataAmount === dataAmount);
        });

        // é¡¯ç¤ºè®Šé«”è³‡è¨Š
        displaySelectedVariant();
        
        // æ›´æ–°è³¼è²·è³‡è¨Š
        updatePurchaseInfo();
    }

    // é¡¯ç¤ºé¸ä¸­çš„è®Šé«”è³‡è¨Š
    function displaySelectedVariant() {
        if (!selectedVariant) return;

        const v = selectedVariant;
        
        // åŸºæœ¬è³‡è¨Š
        document.getElementById('svName').textContent = v.name;
        document.getElementById('svCode').textContent = v.product_code ? `ç”¢å“ä»£ç¢¼ï¼š${v.product_code}` : '';
        
        // é¡å‹å¾½ç« 
        const badge = document.getElementById('svTypeBadge');
        badge.textContent = v.product_type_display;
        badge.className = `variant-type-badge ${v.product_type}`;
        
        // è¦æ ¼è³‡è¨Š
        document.getElementById('svDays').textContent = v.days;
        document.getElementById('svDataAmount').textContent = v.data_amount;
        document.getElementById('svType').textContent = v.product_type_display;
        
        // æè¿°
        document.getElementById('svDescription').textContent = v.description || '';
        
        // æ ¹æ“šç”¨æˆ¶è§’è‰²é¡¯ç¤ºåƒ¹æ ¼
        let displayPrice, originalPrice;
        
        if (userRole.isDistributor) {
            displayPrice = v.price_sales_agent || v.price_agent;
            originalPrice = v.price_agent;
        } else {
            displayPrice = v.price_sales || v.price;
            originalPrice = v.price;
        }
        
        // é¡¯ç¤ºå”®åƒ¹
        document.getElementById('svPrice').textContent = displayPrice ? `$${displayPrice.toLocaleString()}` : 'è«‹æ´½å®¢æœ';
        
        // åŸåƒ¹
        if (userRole.isDistributor) {
            if (v.price_sales_agent && v.price_agent && v.price_agent > v.price_sales_agent) {
                document.getElementById('svPriceOriginal').textContent = `$${v.price_agent.toLocaleString()}`;
                document.getElementById('svPriceOriginal').style.display = 'inline';
            } else {
                document.getElementById('svPriceOriginal').style.display = 'none';
            }
        } else {
            if (v.price_sales && v.price && v.price > v.price_sales) {
                document.getElementById('svPriceOriginal').textContent = `$${v.price.toLocaleString()}`;
                document.getElementById('svPriceOriginal').style.display = 'inline';
            } else {
                document.getElementById('svPriceOriginal').style.display = 'none';
            }
        }
        
        // é¡¯ç¤ºå€å¡Š
        document.getElementById('selectedVariantInfo').classList.add('show');
    }

    // æ›´æ–°è³¼è²·è³‡è¨Š
    function updatePurchaseInfo() {
        if (!selectedVariant) {
            resetPurchaseInfo();
            return;
        }

        const v = selectedVariant;
        
        // æ›´æ–°æ–¹æ¡ˆåç¨±
        document.getElementById('selectedVariantName').textContent = v.name;

        // è¨ˆç®—ç¸½åƒ¹
        const quantity = parseInt(document.getElementById('quantityInput').value);
        let price;
        
        if (userRole.isDistributor) {
            price = v.price_sales_agent || v.price_agent || 0;
        } else {
            price = v.price_sales || v.price || 0;
        }

        const total = price * quantity;
        document.getElementById('totalPrice').textContent = `$${total.toLocaleString()}`;

        // å•Ÿç”¨è³¼è²·æŒ‰éˆ•
        document.getElementById('addToCartBtn').disabled = false;
        document.getElementById('buyNowBtn').disabled = false;
    }

    // é‡ç½®è³¼è²·è³‡è¨Š
    function resetPurchaseInfo() {
        document.getElementById('selectedVariantName').textContent = 'è«‹é¸æ“‡æ–¹æ¡ˆ';
        document.getElementById('totalPrice').textContent = '$0';
        document.getElementById('addToCartBtn').disabled = true;
        document.getElementById('buyNowBtn').disabled = true;
    }

    // å¢åŠ æ•¸é‡
    function increaseQuantity() {
        const input = document.getElementById('quantityInput');
        let value = parseInt(input.value);
        if (value < 999) {
            input.value = value + 1;
            document.getElementById('selectedQuantity').textContent = input.value;
            updatePurchaseInfo();
        }
    }

    // æ¸›å°‘æ•¸é‡
    function decreaseQuantity() {
        const input = document.getElementById('quantityInput');
        let value = parseInt(input.value);
        if (value > 1) {
            input.value = value - 1;
            document.getElementById('selectedQuantity').textContent = input.value;
            updatePurchaseInfo();
        }
    }

    // åŠ å…¥è³¼ç‰©è»Š - å®Œæ•´ç‰ˆ
    document.getElementById('addToCartBtn')?.addEventListener('click', function() {
        if (!selectedVariant) {
            alert('è«‹å…ˆé¸æ“‡æ–¹æ¡ˆé…ç½®');
            return;
        }

        const quantity = parseInt(document.getElementById('quantityInput').value);
        const btn = this;
        
        // é‡æ–°ç²å– CSRF token
        const token = getCsrfToken();
        
        if (!token) {
            alert('âŒ å®‰å…¨é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            console.error('CSRF token is missing');
            return;
        }
        
        // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
        btn.disabled = true;
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> è™•ç†ä¸­...';
        
        // å»ºç«‹ FormData
        const formData = new FormData();
        formData.append('quantity', quantity);
        formData.append('csrfmiddlewaretoken', token);
        
        console.log('ğŸ“¤ Sending request to:', `/business/cart/add/${selectedVariant.id}/`);
        console.log('ğŸ“¦ Variant ID:', selectedVariant.id);
        console.log('ğŸ“¦ Quantity:', quantity);
        console.log('ğŸ”‘ CSRF Token:', token.substring(0, 10) + '...');
        
        // ç™¼é€ AJAX è«‹æ±‚
        fetch(`/business/cart/add/${selectedVariant.id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': token,
            },
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            console.log('ğŸ“¥ Response status:', response.status);
            console.log('ğŸ“¥ Response ok:', response.ok);
            
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('âŒ Response error:', text);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('âœ… Response data:', data);
            
            if (data.success) {
                // æ›´æ–°è³¼ç‰©è»Šåœ–æ¨™æ•¸é‡
                const cartBadge = document.querySelector('.cart-badge');
                if (cartBadge) {
                    cartBadge.textContent = data.cart_count;
                    cartBadge.style.display = 'inline-block';
                }
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                const message = `âœ“ ${data.message}\n\nè³¼ç‰©è»Šå…± ${data.cart_count} ä»¶å•†å“\nç¸½è¨ˆï¼š$${data.total.toLocaleString()}`;
                alert(message);
                
                // è©¢å•æ˜¯å¦å‰å¾€è³¼ç‰©è»Š
                if (confirm('æ˜¯å¦å‰å¾€è³¼ç‰©è»Šçµå¸³ï¼Ÿ')) {
                    window.location.href = '/business/cart/';
                }
            } else {
                alert('âŒ ' + (data.error || 'åŠ å…¥è³¼ç‰©è»Šå¤±æ•—'));
            }
        })
        .catch(error => {
            console.error('âŒ Fetch error:', error);
            console.error('âŒ Error message:', error.message);
            alert(`âŒ åŠ å…¥è³¼ç‰©è»Šå¤±æ•—\n\néŒ¯èª¤è¨Šæ¯ï¼š${error.message}\n\nè«‹é–‹å•Ÿç€è¦½å™¨æ§åˆ¶å°æŸ¥çœ‹è©³ç´°è³‡è¨Š`);
        })
        .finally(() => {
            // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            btn.disabled = false;
            btn.innerHTML = '<i class="fa fa-cart-plus"></i> åŠ å…¥è³¼ç‰©è»Š';
        });
    });

    // ç«‹å³è³¼è²· - å®Œæ•´ç‰ˆ
    document.getElementById('buyNowBtn')?.addEventListener('click', function() {
        if (!selectedVariant) {
            alert('è«‹å…ˆé¸æ“‡æ–¹æ¡ˆé…ç½®');
            return;
        }

        const quantity = parseInt(document.getElementById('quantityInput').value);
        const btn = this;
        const token = getCsrfToken();
        
        if (!token) {
            alert('âŒ å®‰å…¨é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> è™•ç†ä¸­...';
        
        const formData = new FormData();
        formData.append('quantity', quantity);
        formData.append('csrfmiddlewaretoken', token);
        
        // å…ˆåŠ å…¥è³¼ç‰©è»Š
        fetch(`/business/cart/add/${selectedVariant.id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': token,
            },
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // ç›´æ¥è·³è½‰åˆ°è³¼ç‰©è»Š
                window.location.href = '/business/cart/';
            } else {
                alert('âŒ ' + (data.error || 'æ“ä½œå¤±æ•—'));
                btn.disabled = false;
                btn.innerHTML = '<i class="fa fa-bolt"></i> ç«‹å³è³¼è²·';
            }
        })
        .catch(error => {
            console.error('âŒ Error:', error);
            alert(`âŒ æ“ä½œå¤±æ•—\n\néŒ¯èª¤è¨Šæ¯ï¼š${error.message}`);
            btn.disabled = false;
            btn.innerHTML = '<i class="fa fa-bolt"></i> ç«‹å³è³¼è²·';
        });
    });

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        updateDataAmountOptions();
    });
</script>
{% endblock %}