{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load currency %}

{% block title %}<title>è¨‚å–®è©³æƒ… #{{ order.id }} - DB3C ERP</title>{% endblock %}

{% block css %}
<style>
    .order-detail-card {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .order-header {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    .order-status {
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
    }
    .status-PENDING { background: #fff3cd; color: #856404; }
    .status-WAIT { background: #ffeaa7; color: #d63031; }
    .status-PAID { background: #74b9ff; color: #0984e3; }
    .status-WAIT_SHIP { background: #a29bfe; color: #6c5ce7; }
    .status-SHIPPING { background: #81ecec; color: #00b894; }
    .status-WAIT_PICKUP { background: #fab1a0; color: #e17055; }
    .status-DONE { background: #d4edda; color: #155724; }
    .status-CANCELLED { background: #f8d7da; color: #721c24; }
    
    .info-row {
        display: grid;
        grid-template-columns: 150px 1fr;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .info-row:last-child {
        border-bottom: none;
    }
    .info-label {
        font-weight: bold;
        color: #666;
    }
    .info-value {
        color: #333;
    }
    .product-table {
        width: 100%;
        border-collapse: collapse;
    }
    .product-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: bold;
        border-bottom: 2px solid #dee2e6;
    }
    .product-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
    }
    .product-table tr:last-child td {
        border-bottom: none;
    }
    .total-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-top: 15px;
    }
    .total-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 16px;
    }
    .total-row.final {
        font-size: 20px;
        font-weight: bold;
        color: #28a745;
        padding-top: 15px;
        border-top: 2px solid #dee2e6;
    }
    /* åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
    .btn-danger.btn-sm {
        padding: 4px 8px;
        font-size: 12px;
        transition: all 0.3s ease;
    }
    
    .btn-danger.btn-sm:hover {
        background-color: #dc3545 !important;
        transform: scale(1.1);
        box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);
    }
    
    /* ç”¢å“è¡Œåˆªé™¤å‹•ç•« */
    .product-table tbody tr {
        transition: all 0.3s ease;
    }
    
    .product-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* æç¤ºè¨Šæ¯æ¨£å¼ */
    .order-detail-card .order-header .text-muted {
        margin-top: 10px;
        padding: 8px 12px;
        background: #fff3cd;
        border-left: 3px solid #ffc107;
        border-radius: 4px;
    }

    /* æ•¸é‡ç·¨è¼¯è¼¸å…¥æ¡† */
    .quantity-input {
        width: 80px;
        text-align: center;
        padding: 4px 8px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
    
    .quantity-input:focus {
        border-color: #0d6efd;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    /* ç·¨è¼¯æŒ‰éˆ• */
    .btn-edit-quantity {
        padding: 2px 8px;
        font-size: 12px;
        margin-left: 5px;
    }
    
    /* æ–°å¢ç”¢å“è¡¨å–® */
    .add-product-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        border: 2px dashed #dee2e6;
    }
    
    .add-product-form.show {
        border-color: #0d6efd;
        background: #e7f3ff;
    }
    
    /* ç¢ºèªé è¨‚æŒ‰éˆ• */
    .btn-confirm-reservation {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: #fff;
        font-size: 16px;
        font-weight: bold;
        padding: 12px 30px;
        width:100%;
        transition: all 0.3s ease;
    }
    
    .btn-confirm-reservation:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(40, 167, 69, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-xl">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="page-header d-print-none">
            <div class="row align-items-center">
                <div class="col">
                    <h2 class="page-title">
                        è¨‚å–®è©³æƒ… #{{ order.id }}
                    </h2>
                    <div class="text-muted">
                        <i class="ti ti-calendar"></i>
                        {{ order.created_at|date:"Y-m-d H:i:s" }}
                    </div>
                </div>
                <div class="col-auto">
                    <a href="{% url 'business:order_list' %}" class="btn btn-outline-secondary">
                        <i class="ti ti-arrow-left"></i> è¿”å›åˆ—è¡¨
                    </a>
                    
                    {% if can_edit %}
                    <a href="#" class="btn btn-primary">
                        <i class="ti ti-edit"></i> ç·¨è¼¯è¨‚å–®
                    </a>
                    {% endif %}
                    
                    <!-- {% if can_cancel %}
                    <button type="button" class="btn btn-danger" onclick="cancelOrder()">
                        <i class="ti ti-x"></i> å–æ¶ˆè¨‚å–®
                    </button>
                    {% endif %} -->

                    {% if is_headquarter and order.status in 'PENDING,CANCELLED,PAID' %}
                    <a href="{% url 'business:order_delete' order.id %}" class="btn btn-danger">
                        <i class="ti ti-trash"></i> åˆªé™¤è¨‚å–®
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- é è¨‚è¨‚å–®å°ˆç”¨æç¤º -->
        {% if order.status == 'HOLDING' and is_headquarter %}
        <div class="alert alert-warning mb-4">
            <div class="d-flex align-items-center">
                <i class="ti ti-alert-circle me-2" style="font-size: 24px;"></i>
                <div class="flex-grow-1">
                    <h4 class="alert-heading mb-1">é è¨‚è¨‚å–®ï¼ˆHOLDINGï¼‰</h4>
                    <p class="mb-0">
                        æ­¤è¨‚å–®å°šæœªæ‰£é™¤åº«å­˜å’Œå„²å€¼ã€‚æ‚¨å¯ä»¥ç·¨è¼¯è¨‚å–®ç”¢å“ï¼Œå®Œæˆå¾Œè«‹é»æ“Šã€Œç¢ºèªé è¨‚ã€ä»¥æ‰£åº«å­˜å’Œæ‰£æ¬¾ã€‚
                    </p>
                </div>
                <div>
                    <form method="POST" action="{% url 'business:confirm_reservation' order.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-confirm-reservation" onclick="return confirm('ç¢ºå®šè¦ç¢ºèªæ­¤é è¨‚å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡ï¼š\n1. æª¢æŸ¥ä¸¦æ‰£é™¤åº«å­˜\n2. æ‰£é™¤å„²å€¼é‡‘é¡\n3. å°‡è¨‚å–®ç‹€æ…‹æ”¹ç‚ºã€Œå·²ä»˜æ¬¾ã€\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼');">
                            <i class="ti ti-check-circle"></i>
                            ç¢ºèªæ­£å¼ä¸‹å–®
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="row">
            <!-- å·¦å´ï¼šè¨‚å–®è³‡è¨Š -->
            <div class="col-lg-8">
                <!-- è¨‚å–®ç‹€æ…‹ -->
                <div class="order-detail-card">
                    <div class="order-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3>è¨‚å–®ç‹€æ…‹</h3>
                            <span class="order-status status-{{ order.status }}">
                                {{ status_display }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">è¨‚å–®ç·¨è™Ÿ</div>
                        <div class="info-value">{{ order.id }}</div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">æ”¯ä»˜æ–¹å¼</div>
                        <div class="info-value">{{ payment_type_display }}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">è¨‚å–®ä¾†æº</div>
                        <div class="info-value">{{ order.get_source_display }}</div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">å»ºç«‹æ™‚é–“</div>
                        <div class="info-value">{{ order.created_at|date:"Y-m-d H:i:s" }}</div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">æ›´æ–°æ™‚é–“</div>
                        <div class="info-value">{{ order.updated_at|date:"Y-m-d H:i:s" }}</div>
                    </div>
                </div>

                <!-- è¨‚å–®å¸³è™Ÿè³‡è¨Š -->
                <div class="order-detail-card">
                    <div class="order-header">
                        <h3>è¨‚å–®å¸³è™Ÿ</h3>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">å¸³è™Ÿåç¨±</div>
                        <div class="info-value">
                            {{ order.account.username }}
                            {% if is_headquarter or is_agent %}
                            <a href="{% url 'accounts:account_detail' order.account.id %}" class="btn btn-sm btn-link">
                                æŸ¥çœ‹è©³æƒ…
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">å§“å</div>
                        <div class="info-value">{{ order.account.fullname|default:"æœªæä¾›" }}</div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">è§’è‰²</div>
                        <div class="info-value">
                            <span class="badge bg-info">{{ order.account.get_role_display }}</span>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">å…¬å¸</div>
                        <div class="info-value">{{ order.account.company|default:"æœªæä¾›" }}</div>
                    </div>
                    
                    {% if is_created_by_others %}
                    <div class="info-row">
                        <div class="info-label">å»ºç«‹äºº</div>
                        <div class="info-value">
                            <span class="badge bg-warning">
                                ç”± {{ order.created_by.fullname|default:order.created_by.username }} ä»£ç‚ºå»ºç«‹
                            </span>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- è¨‚å–®ç”¢å“ï¼ˆå¢å¼·ç‰ˆï¼‰ -->
                <div class="order-detail-card">
                    <div class="order-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3>è¨‚å–®ç”¢å“</h3>
                                {% if order.status == 'HOLDING' and is_headquarter %}
                                <div class="text-muted small mt-2">
                                    <i class="ti ti-info-circle"></i>
                                    é è¨‚è¨‚å–®å¯ç·¨è¼¯ç”¢å“æ•¸é‡ã€æ–°å¢æˆ–åˆªé™¤ç”¢å“
                                </div>
                                {% endif %}
                            </div>
                            {% if order.status == 'HOLDING' and is_headquarter %}
                            <button type="button" class="btn btn-primary btn-sm" onclick="toggleAddProductForm()">
                                <i class="ti ti-plus"></i>
                                æ–°å¢ç”¢å“
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- æ–°å¢ç”¢å“è¡¨å–® -->
                    {% if order.status == 'HOLDING' and is_headquarter %}
                    <div class="add-product-form" id="addProductForm" style="display: none;">
                        <h5 class="mb-3">æ–°å¢ç”¢å“åˆ°é è¨‚è¨‚å–®</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">é¸æ“‡ç”¢å“</label>
                                <select class="form-select" id="newProductVariant" required>
                                    <option value="">è«‹é¸æ“‡ç”¢å“...</option>
                                    {% for variant in all_variants %}
                                    <option value="{{ variant.id }}" 
                                            data-name="{{ variant.name }}"
                                            data-price="{{ variant.price|default:0 }}">
                                        {{ variant.name }} - ${{ variant.price|currency }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">æ•¸é‡</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="newProductQuantity" 
                                       value="1" 
                                       min="1" 
                                       max="999" 
                                       required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button type="button" class="btn btn-success w-100" onclick="addProduct()">
                                        <i class="ti ti-check"></i>
                                        ç¢ºèªæ–°å¢
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAddProductForm()">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- è¨‚å–®ç”¢å“è¡¨æ ¼ -->
                    <table class="product-table" id="productTable">
                        <thead>
                            <tr>
                                <th>ç”¢å“åç¨±</th>
                                <th>ç”¢å“ä»£ç¢¼</th>
                                <th style="text-align: center;">ç‹€æ…‹</th>
                                <th style="text-align: center; width: 120px;">æ•¸é‡</th>
                                <th style="text-align: right;">å–®åƒ¹</th>
                                <th style="text-align: right;">å°è¨ˆ</th>
                                {% if is_headquarter and order.status == 'HOLDING' %}
                                <th style="text-align: center; width: 100px;">æ“ä½œ</th>
                                {% elif is_headquarter and order.status in 'PENDING,PAID,WAIT' %}
                                <th style="text-align: center; width: 100px;">æ“ä½œ</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.order_products.all %}
                            <tr id="product-row-{{ item.id }}" data-product-id="{{ item.id }}">
                                <td>
                                    <a href="{% url 'business:order_product_detail' order_id=order.id product_id=item.id %}" class="text-decoration-none text-dark fw-bold">
                                        {{ item.variant.name|default:"å·²ä¸‹æ¶å•†å“" }}
                                    </a>
                                    {% if item.variant %}
                                    <div class="text-muted small">
                                        {{ item.variant.get_product_type_display }}
                                        {% if item.variant.days %}
                                        | {{ item.variant.days }} å¤©
                                        {% endif %}
                                        {% if item.variant.data_amount %}
                                        | {{ item.variant.data_amount }}
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <code>{{ item.product_code }}</code>
                                </td>
                                <td style="text-align: center;">
                                    {% if item.status == 'NORMAL' %}
                                        <span class="badge bg-success-lt">æ­£å¸¸</span>
                                    {% elif item.status == 'FAILED' %}
                                        <span class="badge bg-danger-lt">å¤±æ•—</span>
                                    {% elif item.status == 'CANCELED' %}
                                        <span class="badge bg-secondary-lt">å·²å–æ¶ˆ</span>
                                    {% elif item.status == 'RETURNED' %}
                                        <span class="badge bg-warning-lt">å·²é€€è²¨</span>
                                    {% elif item.status == 'DAMAGED' %}
                                        <span class="badge bg-danger">æå£</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ item.get_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td style="text-align: center;">
                                    {% if order.status == 'HOLDING' and is_headquarter %}
                                    <!-- å¯ç·¨è¼¯æ•¸é‡ -->
                                    <input type="number" 
                                           class="quantity-input" 
                                           id="quantity-{{ item.id }}"
                                           value="{{ item.quantity }}" 
                                           min="1" 
                                           max="999"
                                           onchange="updateQuantity({{ item.id }}, this.value)">
                                    {% else %}
                                    {{ item.quantity }}
                                    {% endif %}
                                </td>
                                <td style="text-align: right;">
                                    $<span id="unit-price-{{ item.id }}">{{ item.unit_price|currency }}</span>
                                </td>
                                <td style="text-align: right;">
                                    <strong>$<span id="subtotal-{{ item.id }}">{{ item.amount|currency }}</span></strong>
                                </td>
                                <td style="text-align: center;">
                                    <div class="btn-list justify-content-center">
                                        <!-- æ–°å¢ï¼šæŸ¥çœ‹è©³æƒ…æŒ‰éˆ• -->
                                        <a href="{% url 'business:order_product_detail' order_id=order.id product_id=item.id %}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="æŸ¥çœ‹å…Œæ›è©³æƒ…">
                                            <i class="ti ti-eye"></i> è©³æƒ…
                                        </a>

                                        {% if is_headquarter and order.status == 'HOLDING' %}
                                        <button type="button" 
                                                class="btn btn-sm btn-danger delete-product-btn"
                                                data-product-id="{{ item.id }}"
                                                data-product-name="{{ item.variant.name|default:"å·²ä¸‹æ¶å•†å“" }}"
                                                data-delete-url="{% url 'business:delete_order_product' order.id item.id %}"
                                                title="åˆªé™¤æ­¤ç”¢å“">
                                            <i class="ti ti-trash"></i> åˆªé™¤
                                        </button>
                                        {% elif is_headquarter and order.status in 'PENDING,PAID,WAIT' %}
                                        <button type="button" 
                                                class="btn btn-sm btn-danger delete-product-btn"
                                                data-product-id="{{ item.id }}"
                                                data-product-name="{{ item.variant.name|default:"å·²ä¸‹æ¶å•†å“" }}"
                                                data-delete-url="{% url 'business:delete_order_product' order.id item.id %}"
                                                title="åˆªé™¤æ­¤ç”¢å“">
                                            <i class="ti ti-trash"></i> åˆªé™¤
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr id="empty-row">
                                <td colspan="6" style="text-align: center; padding: 30px;">
                                    <i class="ti ti-shopping-cart-off" style="font-size: 48px; color: #ccc;"></i>
                                    <p class="text-muted">æ­¤è¨‚å–®æ²’æœ‰ç”¢å“</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <!-- é‡‘é¡çµ±è¨ˆ -->
                    <div class="total-section">
                        <div class="total-row">
                            <span>å•†å“ç¸½é¡</span>
                            <span>$<span id="product-total">{{ product_total|currency }}</span></span>
                        </div>
                        <div class="total-row">
                            <span>é‹è²»</span>
                            <span>$<span id="shipping-fee">{{ shipping_fee|currency }}</span></span>
                        </div>
                        <div class="total-row final">
                            <span>è¨‚å–®ç¸½é¡</span>
                            <span>$<span id="order-total">{{ order_total|currency }}</span></span>
                        </div>
                    </div>
                </div>

                <!-- å‚™è¨»è³‡è¨Š -->
                {% if order.remark or order.remark_admin %}
                <div class="order-detail-card">
                    <div class="order-header">
                        <h3>å‚™è¨»è³‡è¨Š</h3>
                    </div>
                    
                    {% if order.remark %}
                    <div class="info-row">
                        <div class="info-label">å®¢æˆ¶å‚™è¨»</div>
                        <div class="info-value">{{ order.remark|linebreaks }}</div>
                    </div>
                    {% endif %}
                    
                    {% if order.remark_admin %}
                    <div class="info-row">
                        <div class="info-label">ç®¡ç†å“¡å‚™è¨»</div>
                        <div class="info-value">
                            <span class="badge bg-danger">ç®¡ç†å“¡</span>
                            {{ order.remark_admin|linebreaks }}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- å³å´ï¼šé™„åŠ è³‡è¨Š -->
            <div class="col-lg-4">
                <!--  ä¿®æ”¹ï¼šè³‡é‡‘ç•°å‹•è¨˜éŒ„ï¼ˆæ”¯æ´å¤šç­†é¡¯ç¤ºï¼‰ -->
                {% if transaction_logs %}
                <div class="order-detail-card">
                    <div class="order-header">
                        <h3>è³‡é‡‘ç•°å‹•è¨˜éŒ„</h3>
                    </div>
                    
                    <div class="list-group list-group-flush">
                        {% for log in transaction_logs %}
                            <div class="list-group-item p-3">
                                <!-- åˆ¤æ–·æ˜¯æ‰£æ¬¾é‚„æ˜¯é€€æ¬¾ -->
                                {% if log.balance_after > log.balance_before %}
                                    <!-- é€€æ¬¾æ¨£å¼ (ç¶ è‰²) -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge bg-success-lt">
                                            <i class="ti ti-arrow-back-up"></i> é€€æ¬¾
                                        </span>
                                        <span class="text-success fw-bold">
                                            + ${{ log.amount|currency }}
                                        </span>
                                    </div>
                                {% else %}
                                    <!-- æ‰£æ¬¾æ¨£å¼ (ç´…è‰²) -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge bg-danger-lt">
                                            <i class="ti ti-shopping-cart"></i> æ‰£æ¬¾
                                        </span>
                                        <span class="text-danger fw-bold">
                                            - ${{ log.amount|currency }}
                                        </span>
                                    </div>
                                {% endif %}

                                <div class="small text-muted mb-1">
                                    <div class="d-flex justify-content-between">
                                        <span>ç•°å‹•å‰ï¼š</span>
                                        <span>${{ log.balance_before|currency }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>ç•°å‹•å¾Œï¼š</span>
                                        <span class="fw-bold text-dark">${{ log.balance_after|currency }}</span>
                                    </div>
                                </div>
                                
                                <div class="text-end text-muted" style="font-size: 0.75rem;">
                                    {{ log.created_at|date:"Y-m-d H:i:s" }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Joytel åƒæ•¸ï¼ˆå¦‚æœæœ‰ï¼‰ -->
                {% if order.warehouse or order.order_code or order.tradeno %}
                <div class="order-detail-card">
                    <div class="order-header">
                        <h3>Joytel åƒæ•¸</h3>
                    </div>
                    
                    {% if order.warehouse %}
                    <div class="info-row">
                        <div class="info-label">åº«å­˜ç·¨è™Ÿ</div>
                        <div class="info-value"><code>{{ order.warehouse }}</code></div>
                    </div>
                    {% endif %}
                    
                    {% if order.order_code %}
                    <div class="info-row">
                        <div class="info-label">Order Code</div>
                        <div class="info-value"><code>{{ order.order_code }}</code></div>
                    </div>
                    {% endif %}
                    
                    {% if order.tradeno %}
                    <div class="info-row">
                        <div class="info-label">Trade No</div>
                        <div class="info-value"><code>{{ order.tradeno }}</code></div>
                    </div>
                    {% endif %}
                    
                    <div class="info-row">
                        <div class="info-label">Order Type</div>
                        <div class="info-value">{{ order.order_type }}</div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">Reply Type</div>
                        <div class="info-value">{{ order.reply_type }}</div>
                    </div>
                </div>
                {% endif %}

                <!-- æ“ä½œè¨˜éŒ„ -->
                <div class="order-detail-card">
                    <div class="order-header">
                        <h3>æ“ä½œè¨˜éŒ„</h3>
                    </div>
                    
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-badge bg-success">
                                <i class="ti ti-plus"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="fw-bold">è¨‚å–®å»ºç«‹</div>
                                <div class="text-muted small">
                                    {{ order.created_at|date:"Y-m-d H:i:s" }}
                                </div>
                            </div>
                        </div>
                        
                        {% if order.status != 'PENDING' %}
                        <div class="timeline-item">
                            <div class="timeline-badge bg-info">
                                <i class="ti ti-check"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="fw-bold">ç‹€æ…‹è®Šæ›´</div>
                                <div class="text-muted small">
                                    {{ order.updated_at|date:"Y-m-d H:i:s" }}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- é è¨‚è¨‚å–®å°ˆç”¨æ“ä½œå€åŸŸ -->
                {% if order.status == 'HOLDING' and is_headquarter %}
                <div class="alert alert-warning">
                    <h4 class="alert-heading">
                        <i class="fa fa-exclamation-triangle"></i>
                        æ­¤è¨‚å–®ç‚ºé è¨‚ç‹€æ…‹ï¼ˆHOLDINGï¼‰
                    </h4>
                    <hr>
                    <p class="mb-3">
                        é è¨‚è¨‚å–®å°šæœªæ‰£é™¤åº«å­˜å’Œå„²å€¼ï¼Œè«‹é¸æ“‡ä»¥ä¸‹æ“ä½œï¼š
                    </p>
                    
                    <div class="row g-2">
                        <div class="col-md-12 mb-3">
                            <!-- <button type="button" 
                                    class="btn btn-success w-100" 
                                    onclick="confirmReservation('{{ order.id }}')">
                                <i class="fa fa-check-circle"></i>
                                ç¢ºèªé è¨‚ï¼ˆæ‰£åº«å­˜ã€æ‰£æ¬¾ï¼‰
                            </button> -->

                            <form method="POST" action="{% url 'business:confirm_reservation' order.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-confirm-reservation w-100 text-white border border-2" onclick="return confirm('ç¢ºå®šè¦ç¢ºèªæ­¤é è¨‚å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡ï¼š\n1. æª¢æŸ¥ä¸¦æ‰£é™¤åº«å­˜\n2. æ‰£é™¤å„²å€¼é‡‘é¡\n3. å°‡è¨‚å–®ç‹€æ…‹æ”¹ç‚ºã€Œå·²ä»˜æ¬¾ã€\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼');">
                                    <i class="fa fa-check-circle"></i>
                                    ç¢ºèªæ­£å¼ä¸‹å–®ï¼ˆæ‰£æ¬¾ï¼‰
                                </button>
                            </form>
                        </div>
                        <div class="col-md-12">
                            <a href="{% url 'business:order_delete' order.id %}" 
                            class="btn btn-danger w-100">
                                <i class="fa fa-times-circle"></i>
                                å–æ¶ˆé è¨‚ï¼ˆåˆªé™¤è¨‚å–®ï¼‰
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}


            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scriptcontent %}
<script>
    // ç²å–æ­£ç¢ºçš„è¨‚å–® ID
    const ORDER_ID = '{{ order.id }}';
    console.log('ğŸ“¦ è¨‚å–® ID:', ORDER_ID);

    // é¡¯ç¤º/éš±è—æ–°å¢ç”¢å“è¡¨å–®
    function toggleAddProductForm() {
        const form = document.getElementById('addProductForm');
        if (form.style.display === 'none') {
            form.style.display = 'block';
            form.classList.add('show');
        } else {
            form.style.display = 'none';
            form.classList.remove('show');
        }
    }
    
    // æ›´æ–°è¨‚å–®ç”¢å“æ•¸é‡ï¼ˆAJAXï¼‰
    function updateQuantity(productId, newQuantity) {
        // é©—è­‰æ•¸é‡
        newQuantity = parseInt(newQuantity);
        if (isNaN(newQuantity) || newQuantity < 1) {
            newQuantity = 1;
        }
        if (newQuantity > 999) {
            newQuantity = 999;
        }
        
        // æ›´æ–°è¼¸å…¥æ¡†é¡¯ç¤º
        document.getElementById(`quantity-${productId}`).value = newQuantity;
        
        // âœ… ä½¿ç”¨æ­£ç¢ºçš„ URL
        const updateUrl = `/business/orders/${ORDER_ID}/reservation/products/${productId}/update/`;
        console.log('ğŸ”— æ›´æ–° URL:', updateUrl);
        
        // ç™¼é€ AJAX è«‹æ±‚
        fetch(updateUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `quantity=${newQuantity}`
        })
        .then(response => {
            console.log('ğŸ“¥ Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('âœ… Response data:', data);
            
            if (data.success) {
                // æ›´æ–°å°è¨ˆ
                document.getElementById(`subtotal-${productId}`).textContent = 
                    data.subtotal.toLocaleString('zh-TW', {minimumFractionDigits: 0});
                
                // æ›´æ–°è¨‚å–®ç¸½é¡
                document.getElementById('order-total').textContent = 
                    data.total.toLocaleString('zh-TW', {minimumFractionDigits: 0});
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showToast('success', data.message);
            } else {
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                showToast('error', data.error);
                location.reload();
            }
        })
        .catch(error => {
            console.error('âŒ Error:', error);
            showToast('error', 'æ›´æ–°æ•¸é‡å¤±æ•—ï¼š' + error.message);
            location.reload();
        });
    }
    
    // âœ… æ–°å¢ç”¢å“åˆ°è¨‚å–®ï¼ˆAJAXï¼‰
    function addProduct() {
        const variantSelect = document.getElementById('newProductVariant');
        const quantityInput = document.getElementById('newProductQuantity');
        
        const variantId = variantSelect.value;
        const quantity = parseInt(quantityInput.value);
        
        // é©—è­‰
        if (!variantId) {
            showToast('error', 'è«‹é¸æ“‡ç”¢å“');
            return;
        }
        
        if (isNaN(quantity) || quantity < 1) {
            showToast('error', 'æ•¸é‡å¿…é ˆå¤§æ–¼ 0');
            return;
        }
        
        // âœ… ä½¿ç”¨æ­£ç¢ºçš„ URL
        const addUrl = `/business/orders/${ORDER_ID}/reservation/products/add/`;
        console.log('ğŸ”— æ–°å¢ URL:', addUrl);
        
        // ç™¼é€ AJAX è«‹æ±‚
        fetch(addUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `variant_id=${variantId}&quantity=${quantity}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message);
                location.reload();
            } else {
                showToast('error', data.error);
            }
        })
        .catch(error => {
            console.error('âŒ Error:', error);
            showToast('error', 'æ–°å¢ç”¢å“å¤±æ•—ï¼š' + error.message);
        });
    }
    
    // âœ… åˆªé™¤è¨‚å–®ç”¢å“
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.delete-product-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const productId = this.getAttribute('data-product-id');
                const productName = this.getAttribute('data-product-name');
                
                console.log('ğŸ—‘ï¸ åˆªé™¤ç”¢å“ ID:', productId);
                console.log('ğŸ“¦ è¨‚å–® ID:', ORDER_ID);
                
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç”¢å“ã€Œ${productName}ã€å—ï¼Ÿ\n\nâš ï¸ æ­¤æ“ä½œå°‡ï¼š\n1. åˆªé™¤æ­¤ç”¢å“\n2. æ¢å¾©åº«å­˜ï¼ˆå¦‚å·²æ‰£åº«å­˜ï¼‰\n3. é€€å›å„²å€¼é‡‘é¡ï¼ˆå¦‚å·²æ‰£æ¬¾ï¼‰\n4. é‡æ–°è¨ˆç®—è¨‚å–®ç¸½é¡\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                    return;
                }
                
                // âœ… ä½¿ç”¨æ­£ç¢ºçš„ URL
                const deleteUrl = `/business/orders/${ORDER_ID}/products/${productId}/delete/`;
                console.log('ğŸ”— åˆªé™¤ URL:', deleteUrl);
                
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = deleteUrl;
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = '{{ csrf_token }}';
                form.appendChild(csrfInput);
                
                document.body.appendChild(form);
                form.submit();
            });
        });
    });
    
    // âœ… é¡¯ç¤ºæç¤ºè¨Šæ¯ï¼ˆToastï¼‰
    function showToast(type, message) {
        // ä½¿ç”¨ Bootstrap Toast æˆ–ç°¡å–®çš„ alert
        if (type === 'success') {
            alert('âœ… ' + message);
        } else {
            alert('âŒ ' + message);
        }
    }
    // ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†åˆªé™¤æŒ‰éˆ•é»æ“Š
    // document.addEventListener('DOMContentLoaded', function() {
    //     // ç‚ºæ‰€æœ‰åˆªé™¤æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
    //     document.querySelectorAll('.delete-product-btn').forEach(function(button) {
    //         button.addEventListener('click', function() {
    //             const productId = this.getAttribute('data-product-id');
    //             const productName = this.getAttribute('data-product-name');
    //             const deleteUrl = this.getAttribute('data-delete-url');
                
    //             console.log('ç”¢å“ ID:', productId);
    //             console.log('ç”¢å“åç¨±:', productName);
    //             console.log('åˆªé™¤ URL:', deleteUrl);
                
    //             // ç¢ºèªå°è©±æ¡†
    //             if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç”¢å“ã€Œ${productName}ã€å—ï¼Ÿ\n\nâš ï¸ æ­¤æ“ä½œå°‡ï¼š\n1. åˆªé™¤æ­¤ç”¢å“\n2. æ¢å¾©åº«å­˜\n3. é€€å›å„²å€¼é‡‘é¡ï¼ˆå¦‚é©ç”¨ï¼‰\n4. é‡æ–°è¨ˆç®—è¨‚å–®ç¸½é¡\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
    //                 return;
    //             }
                
    //             // å»ºç«‹è¡¨å–®ä¸¦æäº¤
    //             const form = document.createElement('form');
    //             form.method = 'POST';
    //             form.action = deleteUrl;
                
    //             // æ·»åŠ  CSRF token
    //             const csrfInput = document.createElement('input');
    //             csrfInput.type = 'hidden';
    //             csrfInput.name = 'csrfmiddlewaretoken';
    //             csrfInput.value = '{{ csrf_token }}';
    //             form.appendChild(csrfInput);
                
    //             document.body.appendChild(form);
    //             form.submit();
    //         });
    //     });
    // });
    // function cancelOrder() {
    //     if (confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤è¨‚å–®å—ï¼Ÿ')) {
    //         // TODO: å¯¦ä½œå–æ¶ˆè¨‚å–®çš„ AJAX è«‹æ±‚
    //         alert('å–æ¶ˆè¨‚å–®åŠŸèƒ½é–‹ç™¼ä¸­...');
    //     }
    // }
</script>
{% endblock %}