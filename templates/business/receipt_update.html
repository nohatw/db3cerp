{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}<title>{% if object %}ç·¨è¼¯{% else %}æ–°å¢{% endif %}æ”¶æ“š - DB3C ERP</title>{% endblock %}

{% block css %}
<style>
    .form-container {
        max-width: 900px;
        margin: 0 auto;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 16px rgba(0,0,0,0.1);
        padding: 40px;
    }
    
    .form-section {
        margin-bottom: 30px;
        padding-bottom: 30px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .form-section:last-child {
        border-bottom: none;
    }
    
    .form-section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #495057;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    /* ç”¢å“æ˜ç´°è¡¨æ ¼ */
    .product-items-table {
        width: 100%;
        margin-top: 20px;
    }
    
    .product-items-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
    }
    
    .product-items-table td {
        padding: 10px;
        vertical-align: middle;
    }
    
    .product-item-row {
        background: #fff;
        transition: all 0.3s ease;
    }
    
    .product-item-row:hover {
        background: #f8f9fa;
    }
    
    /* ç¸½è¨ˆå€åŸŸ */
    .total-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    .total-amount {
        color: #28a745;
    }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn-add-item {
        width: 100%;
        padding: 12px;
        margin-top: 15px;
        border: 2px dashed #0d6efd;
        background: #f8f9fa;
        color: #0d6efd;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-add-item:hover {
        background: #e7f3ff;
        border-color: #0056b3;
        color: #0056b3;
    }
    
    .btn-remove-item {
        padding: 8px 12px;
        font-size: 0.9rem;
    }
    
    /* è¡¨å–®æ§åˆ¶å…ƒä»¶ */
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 10px 15px;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }
    
    /* å¿…å¡«æ¨™è¨˜ */
    .required-mark {
        color: #dc3545;
        margin-left: 3px;
    }
    
    /* å¹«åŠ©æ–‡å­— */
    .form-text {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-xl">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h2 class="page-title">
                        <i class="ti ti-receipt-plus"></i> 
                        {% if object %}ç·¨è¼¯æ”¶æ“š{% else %}æ–°å¢æ”¶æ“š{% endif %}
                    </h2>
                    <div class="text-muted">
                        {% if object %}
                            ç·¨è¼¯æ”¶æ“šç·¨è™Ÿï¼š{{ object.receipt_number }}
                        {% else %}
                            æ‰‹å‹•å»ºç«‹æ”¶æ“šè¨˜éŒ„
                        {% endif %}
                    </div>
                </div>
                <div class="col-auto">
                    <a href="{% url 'business:receipt_list' %}" class="btn btn-outline-secondary">
                        <i class="ti ti-arrow-left"></i> è¿”å›åˆ—è¡¨
                    </a>
                </div>
            </div>
        </div>

        <!-- è¡¨å–® -->
        <div class="form-container">
            <form method="post" id="receiptForm">
                {% csrf_token %}
                
                <!-- åŸºæœ¬è³‡è¨Š -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="ti ti-info-circle"></i> åŸºæœ¬è³‡è¨Š
                    </div>
                    
                    <div class="row g-3">
                        <!-- æ”¶æ“šæŠ¬é ­ -->
                        <div class="col-md-6">
                            <label class="form-label">
                                æ”¶æ“šæŠ¬é ­ <span class="required-mark">*</span>
                            </label>
                            {{ form.receipt_to|add_class:"form-control" }}
                            {% if form.receipt_to.errors %}
                                <div class="text-danger mt-1">{{ form.receipt_to.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                <i class="ti ti-info-circle"></i> 
                                æ”¶æ“šæŠ¬é ­ï¼ˆå€‹äººæˆ–å…¬å¸åç¨±ï¼‰
                            </div>
                        </div>
                        
                        <!-- çµ±ä¸€ç·¨è™Ÿ -->
                        <div class="col-md-6">
                            <label class="form-label">
                                çµ±ä¸€ç·¨è™Ÿ
                            </label>
                            {{ form.taxid|add_class:"form-control" }}
                            {% if form.taxid.errors %}
                                <div class="text-danger mt-1">{{ form.taxid.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                <i class="ti ti-info-circle"></i> 
                                é¸å¡«ï¼Œå¦‚éœ€ä¸‰è¯å¼ç™¼ç¥¨è«‹å¡«å¯«
                            </div>
                        </div>
                        
                        <!-- æ”¶æ“šæ—¥æœŸ -->
                        <div class="col-md-6">
                            <label class="form-label">
                                æ”¶æ“šæ—¥æœŸ <span class="required-mark">*</span>
                            </label>
                            {{ form.date|add_class:"form-control"|attr:"type:date" }}
                            {% if form.date.errors %}
                                <div class="text-danger mt-1">{{ form.date.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                <i class="ti ti-calendar"></i> 
                                æ”¶æ“šé–‹ç«‹æ—¥æœŸ
                            </div>
                        </div>
                        
                        <!-- å‚™è¨» -->
                        <div class="col-12">
                            <label class="form-label">
                                å‚™è¨»
                            </label>
                            {{ form.remark }}
                            {% if form.remark.errors %}
                                <div class="text-danger mt-1">{{ form.remark.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                <i class="ti ti-note"></i> 
                                å…¶ä»–ç›¸é—œèªªæ˜æˆ–å‚™è¨»
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç”¢å“æ˜ç´° -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="ti ti-list"></i> ç”¢å“æ˜ç´°
                    </div>
                    
                    <table class="product-items-table table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">åºè™Ÿ</th>
                                <th style="width: 35%;">ç”¢å“åç¨± <span class="required-mark">*</span></th>
                                <th style="width: 20%;">ç”¢å“ä»£ç¢¼</th>
                                <th style="width: 15%;">æ•¸é‡ <span class="required-mark">*</span></th>
                                <th style="width: 15%;">å–®åƒ¹ <span class="required-mark">*</span></th>
                                <th style="width: 10%;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="productItemsBody">
                            <!-- âœ… ç·¨è¼¯æ¨¡å¼ï¼šé¡¯ç¤ºç¾æœ‰çš„ç”¢å“æ˜ç´° -->
                            {% if object and receipt_items %}
                                {% for item in receipt_items %}
                                <tr class="product-item-row">
                                    <td class="text-center item-number">{{ forloop.counter }}</td>
                                    <td>
                                        <input type="text" name="product_name[]" class="form-control" 
                                            placeholder="è«‹è¼¸å…¥ç”¢å“åç¨±" value="{{ item.product_name }}" required>
                                    </td>
                                    <td>
                                        <input type="text" name="product_code[]" class="form-control" 
                                            placeholder="é¸å¡«" value="{{ item.product_code|default:'' }}">
                                    </td>
                                    <td>
                                        <input type="number" name="quantity[]" class="form-control quantity-input" 
                                            placeholder="æ•¸é‡" min="1" value="{{ item.quantity }}" required 
                                            oninput="calculateReceiptTotal()">
                                    </td>
                                    <td>
                                        <input type="number" name="unit_price[]" class="form-control price-input" 
                                            placeholder="å–®åƒ¹" min="0" step="1" value="{{ item.unit_price }}" required 
                                            oninput="calculateReceiptTotal()">
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="removeReceiptItem(this)">
                                            <i class="ti ti-trash"></i> åˆªé™¤
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <!-- æ–°å¢æ¨¡å¼ï¼šé¡¯ç¤ºä¸€è¡Œç©ºç™½ -->
                                <tr class="product-item-row">
                                    <td class="text-center item-number">1</td>
                                    <td>
                                        <input type="text" name="product_name[]" class="form-control" 
                                            placeholder="è«‹è¼¸å…¥ç”¢å“åç¨±" required>
                                    </td>
                                    <td>
                                        <input type="text" name="product_code[]" class="form-control" 
                                            placeholder="é¸å¡«">
                                    </td>
                                    <td>
                                        <input type="number" name="quantity[]" class="form-control quantity-input" 
                                            placeholder="æ•¸é‡" min="1" value="1" required 
                                            oninput="calculateReceiptTotal()">
                                    </td>
                                    <td>
                                        <input type="number" name="unit_price[]" class="form-control price-input" 
                                            placeholder="å–®åƒ¹" min="0" step="1" required 
                                            oninput="calculateReceiptTotal()">
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="removeReceiptItem(this)" disabled>
                                            <i class="ti ti-trash"></i> åˆªé™¤
                                        </button>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                    
                    <!-- æ–°å¢æŒ‰éˆ• -->
                    <button type="button" class="btn btn-add-item" onclick="addReceiptItem(); return false;">
                        <i class="ti ti-plus"></i> æ–°å¢ç”¢å“é …ç›®
                    </button>
                    
                    <!-- ç¸½è¨ˆå€åŸŸ -->
                    <div class="total-section">
                        <div class="total-row">
                            <div>æ”¶æ“šç¸½è¨ˆ</div>
                            <div class="total-amount" id="totalAmount">$0</div>
                        </div>
                        <div class="text-muted small mt-2">
                            <i class="ti ti-info-circle"></i> 
                            è‡ªå‹•è¨ˆç®—æ‰€æœ‰ç”¢å“æ˜ç´°çš„ç¸½é‡‘é¡
                        </div>
                    </div>
                </div>

                <!-- è¡¨å–®éŒ¯èª¤è¨Šæ¯ -->
                {% if form.errors %}
                <div class="alert alert-danger">
                    <h4><i class="ti ti-alert-triangle"></i> è¡¨å–®éŒ¯èª¤</h4>
                    <ul class="mb-0">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li>{{ field }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- æäº¤æŒ‰éˆ• -->
                <div class="d-flex gap-2 justify-content-end">
                    <a href="{% url 'business:receipt_list' %}" class="btn btn-outline-secondary">
                        <i class="ti ti-x"></i> å–æ¶ˆ
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="ti ti-check"></i> 
                        {% if object %}æ›´æ–°æ”¶æ“š{% else %}å»ºç«‹æ”¶æ“š{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scriptcontent2 %}
<script>
    console.log('ğŸš€ æ”¶æ“šè¡¨å–® JavaScript è¼‰å…¥ä¸­...');

    let receiptItemCount = {% if object and receipt_items %}{{ receipt_items.count }}{% else %}1{% endif %};

    console.log('ğŸ“Š åˆå§‹é …ç›®æ•¸é‡ï¼š' + receiptItemCount);

    // âœ… æ–°å¢é …ç›®ï¼ˆå…¨åŸŸå‡½æ•¸ï¼‰
    function addReceiptItem() {
        console.log('ğŸ”¥ addReceiptItem() è¢«å‘¼å«');
        
        const tbody = document.getElementById('productItemsBody');
        if (!tbody) {
            console.error('âŒ æ‰¾ä¸åˆ° productItemsBody');
            alert('âŒ ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¡¨æ ¼');
            return false;
        }
        
        receiptItemCount++;
        console.log('âœ… æ‰¾åˆ° tbodyï¼Œæº–å‚™æ–°å¢ç¬¬ ' + receiptItemCount + ' é …');
        
        const row = document.createElement('tr');
        row.className = 'product-item-row';
        row.innerHTML = `
            <td class="text-center item-number">${receiptItemCount}</td>
            <td>
                <input type="text" name="product_name[]" class="form-control" 
                    placeholder="è«‹è¼¸å…¥ç”¢å“åç¨±" required>
            </td>
            <td>
                <input type="text" name="product_code[]" class="form-control" 
                    placeholder="é¸å¡«">
            </td>
            <td>
                <input type="number" name="quantity[]" class="form-control quantity-input" 
                    placeholder="æ•¸é‡" min="1" value="1" required 
                    oninput="calculateReceiptTotal()">
            </td>
            <td>
                <input type="number" name="unit_price[]" class="form-control price-input" 
                    placeholder="å–®åƒ¹" min="0" step="1" required 
                    oninput="calculateReceiptTotal()">
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger" 
                        onclick="removeReceiptItem(this)">
                    <i class="ti ti-trash"></i> åˆªé™¤
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        console.log('âœ… å·²æ–°å¢è¡Œåˆ° DOM');
        
        updateReceiptRowNumbers();
        updateReceiptRemoveButtons();
        calculateReceiptTotal();
        
        console.log('âœ… å·²æ–°å¢ç¬¬ ' + receiptItemCount + ' é …');
        return false;
    }

    // âœ… ç§»é™¤é …ç›®ï¼ˆå…¨åŸŸå‡½æ•¸ï¼‰
    function removeReceiptItem(button) {
        console.log('ğŸ”¥ removeReceiptItem() è¢«å‘¼å«');
        
        const row = button.closest('tr');
        if (!row) {
            console.error('âŒ æ‰¾ä¸åˆ°è¡Œå…ƒç´ ');
            return false;
        }
        
        // æª¢æŸ¥æ˜¯å¦è‡³å°‘ä¿ç•™ä¸€è¡Œ
        const rows = document.querySelectorAll('.product-item-row');
        if (rows.length <= 1) {
            alert('âš ï¸ è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹ç”¢å“é …ç›®');
            console.warn('âš ï¸ ç„¡æ³•åˆªé™¤ï¼šè‡³å°‘éœ€è¦ä¸€å€‹é …ç›®');
            return false;
        }
        
        row.remove();
        console.log('âœ… å·²ç§»é™¤é …ç›®');
        
        updateReceiptRowNumbers();
        updateReceiptRemoveButtons();
        calculateReceiptTotal();
        
        console.log('âœ… å‰©é¤˜ ' + document.querySelectorAll('.product-item-row').length + ' é …');
        return false;
    }

    // æ›´æ–°è¡Œè™Ÿ
    function updateReceiptRowNumbers() {
        const rows = document.querySelectorAll('.product-item-row');
        console.log('ğŸ“Š æ›´æ–°è¡Œè™Ÿï¼Œå…± ' + rows.length + ' è¡Œ');
        
        rows.forEach((row, index) => {
            const cell = row.querySelector('.item-number');
            if (cell) {
                cell.textContent = index + 1;
            }
        });
        
        // åŒæ­¥æ›´æ–° receiptItemCount
        receiptItemCount = rows.length;
    }

    // æ›´æ–°åˆªé™¤æŒ‰éˆ•ç‹€æ…‹
    function updateReceiptRemoveButtons() {
        const rows = document.querySelectorAll('.product-item-row');
        const buttons = document.querySelectorAll('.product-item-row button[onclick*="removeReceiptItem"]');
        
        console.log('ğŸ”˜ æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ï¼Œå…± ' + buttons.length + ' å€‹æŒ‰éˆ•');
        
        // åªæœ‰ä¸€è¡Œæ™‚ç¦ç”¨æ‰€æœ‰åˆªé™¤æŒ‰éˆ•
        const shouldDisable = (rows.length <= 1);
        buttons.forEach(btn => {
            btn.disabled = shouldDisable;
            if (shouldDisable) {
                btn.classList.add('disabled');
            } else {
                btn.classList.remove('disabled');
            }
        });
    }

    // è¨ˆç®—ç¸½é‡‘é¡
    function calculateReceiptTotal() {
        let total = 0;
        const rows = document.querySelectorAll('.product-item-row');
        
        rows.forEach(row => {
            const qtyInput = row.querySelector('.quantity-input');
            const priceInput = row.querySelector('.price-input');
            
            const qty = parseFloat(qtyInput?.value) || 0;
            const price = parseFloat(priceInput?.value) || 0;
            
            total += qty * price;
        });
        
        const totalElement = document.getElementById('totalAmount');
        if (totalElement) {
            totalElement.textContent = '$' + total.toLocaleString('zh-TW', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }
        
        console.log('ğŸ’° ç¸½é‡‘é¡ï¼š$' + total);
    }

    // è¡¨å–®æäº¤é©—è­‰
    function validateReceiptForm(e) {
        const rows = document.querySelectorAll('.product-item-row');
        
        if (rows.length === 0) {
            e.preventDefault();
            alert('âŒ è«‹è‡³å°‘æ–°å¢ä¸€å€‹ç”¢å“é …ç›®');
            return false;
        }
        
        // æª¢æŸ¥å¿…å¡«æ¬„ä½
        let hasError = false;
        let errorMessages = [];
        
        rows.forEach((row, index) => {
            const nameInput = row.querySelector('input[name="product_name[]"]');
            const quantityInput = row.querySelector('input[name="quantity[]"]');
            const priceInput = row.querySelector('input[name="unit_price[]"]');
            
            const name = nameInput?.value.trim();
            const quantity = quantityInput?.value;
            const price = priceInput?.value;
            
            if (!name) {
                hasError = true;
                errorMessages.push(`ç¬¬ ${index + 1} é …ï¼šç¼ºå°‘ç”¢å“åç¨±`);
            }
            if (!quantity || quantity <= 0) {
                hasError = true;
                errorMessages.push(`ç¬¬ ${index + 1} é …ï¼šæ•¸é‡å¿…é ˆå¤§æ–¼ 0`);
            }
            if (!price || price < 0) {
                hasError = true;
                errorMessages.push(`ç¬¬ ${index + 1} é …ï¼šå–®åƒ¹ä¸èƒ½ç‚ºè² æ•¸`);
            }
        });
        
        if (hasError) {
            e.preventDefault();
            alert('âŒ è¡¨å–®é©—è­‰å¤±æ•—ï¼š\n\n' + errorMessages.join('\n'));
            console.error('âŒ è¡¨å–®é©—è­‰éŒ¯èª¤ï¼š', errorMessages);
            return false;
        }
        
        console.log('âœ… è¡¨å–®é©—è­‰é€šé');
        return true;
    }

    // DOM è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        console.log('âœ… DOM è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–');
        
        // ç¶å®šè¡¨å–®æäº¤äº‹ä»¶
        const form = document.getElementById('receiptForm');
        if (form) {
            form.addEventListener('submit', validateReceiptForm);
            console.log('âœ… å·²ç¶å®šè¡¨å–®æäº¤é©—è­‰');
        } else {
            console.error('âŒ æ‰¾ä¸åˆ° receiptForm');
        }
        
        // åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹å’Œç¸½é‡‘é¡
        updateReceiptRemoveButtons();
        calculateReceiptTotal();
        
        // æª¢æŸ¥å…ƒç´ 
        const addBtn = document.querySelector('.btn-add-item');
        const tbody = document.getElementById('productItemsBody');
        const rows = document.querySelectorAll('.product-item-row');
        
        console.log('ğŸ” å…ƒç´ æª¢æŸ¥ï¼š');
        console.log('  âœ“ æ–°å¢æŒ‰éˆ•:', addBtn ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
        console.log('  âœ“ è¡¨æ ¼ tbody:', tbody ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
        console.log('  âœ“ ç¾æœ‰è¡Œæ•¸:', rows.length);
        console.log('  âœ“ é …ç›®è¨ˆæ•¸å™¨:', receiptItemCount);
        
        // æ¸¬è©¦æŒ‰éˆ•é»æ“Š
        if (addBtn) {
            console.log('âœ… æ–°å¢æŒ‰éˆ•å·²æº–å‚™å°±ç·’');
        }
        
        console.log('ğŸ‰ æ”¶æ“šè¡¨å–®åˆå§‹åŒ–å®Œæˆï¼');
    });
</script>
{% endblock %}