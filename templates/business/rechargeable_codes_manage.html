{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}<title>å¡è™Ÿç®¡ç† - {{ order_product.variant.name }} - DB3C ERP</title>{% endblock %}

{% block css %}
<style>
    .code-input {
        font-family: 'Courier New', monospace;
        font-size: 14px;
    }
    
    .code-row {
        transition: background-color 0.2s;
    }
    
    .code-row:hover {
        background-color: #f8f9fa;
    }
    
    /* âœ… æ–°å¢ï¼šæ´»å‹•ä¸­çš„è¼¸å…¥æ¡†æ¨£å¼ */
    .code-input.active-scan {
        border: 2px solid #0d6efd;
        background-color: #e7f1ff;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .filled-badge {
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
    }
    
    .empty-badge {
        background: #dc3545;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
    }
    
    .stats-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-xl">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="page-header d-print-none">
            <div class="row align-items-center">
                <div class="col">
                    <div class="page-pretitle">
                        <a href="{% url 'business:order_detail' pk=order_product.order.id %}">
                            è¨‚å–® #{{ order_product.order.id }}
                        </a>
                        /
                        <a href="{% url 'business:order_product_detail' order_id=order_product.order.id product_id=order_product.id %}">
                            ç”¢å“è©³æƒ…
                        </a>
                    </div>
                    <h2 class="page-title">
                        <i class="ti ti-credit-card"></i>
                        å¡è™Ÿç®¡ç†ï¼š{{ order_product.variant.name }}
                    </h2>
                </div>
                <div class="col-auto ms-auto d-print-none">
                    <a href="{% url 'business:order_product_detail' order_id=order_product.order.id product_id=order_product.id %}" 
                       class="btn btn-outline-secondary">
                        <i class="ti ti-arrow-left"></i> è¿”å›ç”¢å“è©³æƒ…
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <!-- çµ±è¨ˆè³‡è¨Š -->
                <div class="stats-card">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="mb-2">
                                <i class="ti ti-credit-card" style="font-size: 24px; color: #0d6efd;"></i>
                            </div>
                            <h3 class="mb-0">{{ total_codes }}</h3>
                            <small class="text-muted">ç¸½å¡è™Ÿæ•¸</small>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-2">
                                <i class="ti ti-check-circle" style="font-size: 24px; color: #28a745;"></i>
                            </div>
                            <h3 class="mb-0 text-success">{{ filled_codes }}</h3>
                            <small class="text-muted">å·²å¡«å¯«</small>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-2">
                                <i class="ti ti-alert-circle" style="font-size: 24px; color: #dc3545;"></i>
                            </div>
                            <h3 class="mb-0 text-danger">{{ empty_codes }}</h3>
                            <small class="text-muted">æœªå¡«å¯«</small>
                        </div>
                    </div>
                </div>

                <!-- âœ… æ–°å¢ï¼šæƒææ¨¡å¼æç¤º -->
                {% if is_headquarter %}
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <i class="ti ti-scan me-2" style="font-size: 24px;"></i>
                        <div>
                            <strong>æƒææ§ä½¿ç”¨èªªæ˜ï¼š</strong>
                            <ul class="mb-0 mt-2">
                                <li>é é¢è¼‰å…¥å¾Œï¼Œæœƒè‡ªå‹•èšç„¦åˆ°ç¬¬ä¸€å€‹æœªå¡«å¯«çš„å¡è™Ÿæ¬„ä½ï¼ˆè—è‰²é‚Šæ¡†ï¼‰</li>
                                <li>ä½¿ç”¨æƒææ§æƒæå¡è™Ÿï¼Œæœƒè‡ªå‹•å¡«å…¥ç•¶å‰èšç„¦çš„æ¬„ä½</li>
                                <li>å¡«å…¥å¾Œæœƒè‡ªå‹•è·³åˆ°ä¸‹ä¸€å€‹æœªå¡«å¯«çš„æ¬„ä½</li>
                                <li>å¦‚éœ€ä¿®æ”¹å·²å¡«å¯«çš„å¡è™Ÿï¼Œè«‹ç”¨æ»‘é¼ é»æ“Šè©²æ¬„ä½å¾Œå†æƒæ</li>
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- âœ… æ–°å¢ï¼šCSV æ‰¹é‡åŒ¯å…¥å€å¡Š -->
                {% if is_headquarter %}
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-file-upload"></i> CSV æ‰¹é‡åŒ¯å…¥
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <strong>CSV æ ¼å¼èªªæ˜ï¼š</strong>
                            <ul class="mb-0 mt-2">
                                <li>æ”¯æ´å…©ç¨®æ ¼å¼ï¼š<code>åºè™Ÿ,å¡è™Ÿ</code> æˆ– <code>å¡è™Ÿ</code></li>
                                <li>ç¯„ä¾‹ï¼š<code>1,ABC123456789</code> æˆ– <code>ABC123456789</code></li>
                                <li>å¡è™ŸæœƒæŒ‰é †åºåŒ¹é…åˆ°å°æ‡‰çš„åºè™Ÿæ¬„ä½</li>
                                <li>CSV æª”æ¡ˆæ•¸é‡ä¸å¯è¶…éè¨‚å–®ç”¢å“æ•¸é‡ï¼ˆ{{ total_codes }} å¼µï¼‰</li>
                                <li>æ”¯æ´ UTF-8 æˆ– Big5 ç·¨ç¢¼</li>
                            </ul>
                        </div>
                        
                        <form id="csvUploadForm" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="row align-items-end">
                                <div class="col-md-6">
                                    <label class="form-label">é¸æ“‡ CSV æª”æ¡ˆ</label>
                                    <input 
                                        type="file" 
                                        name="csv_file" 
                                        id="csvFileInput"
                                        class="form-control" 
                                        accept=".csv"
                                        required
                                    >
                                </div>
                                <div class="col-md-4">
                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="ti ti-upload"></i> ä¸Šå‚³ä¸¦åŒ¯å…¥
                                    </button>
                                </div>
                                <div class="col-md-2">
                                    <a href="#" id="downloadCsvTemplate" class="btn btn-outline-secondary btn-sm">
                                        <i class="ti ti-download"></i> ä¸‹è¼‰ CSV
                                    </a>

                                </div>
                            </div>
                        </form>
                        
                        <!-- CSV ç¯„æœ¬ä¸‹è¼‰ -->
                        <!-- <div class="mt-3">
                            <a href="#" id="downloadCsvTemplate" class="btn btn-outline-secondary btn-sm">
                                <i class="ti ti-download"></i> ä¸‹è¼‰ CSV ç¯„æœ¬
                            </a>
                        </div> -->
                    </div>
                </div>
                {% endif %}

                <!-- å¡è™Ÿåˆ—è¡¨ -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">å¡è™Ÿåˆ—è¡¨</h3>
                        <div class="card-actions">
                            <small class="text-muted">
                                å…± {{ total_codes }} å¼µå¡
                            </small>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if messages %}
                        <div class="mb-3">
                            {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message|safe }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <form method="post" action="{% url 'business:save_rechargeable_codes' order_id=order_product.order.id product_id=order_product.id %}" id="codesForm">
                            {% csrf_token %}
                            
                            <div class="table-responsive">
                                <table class="table table-vcenter">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%;">åºè™Ÿ</th>
                                            <th style="width: 70%;">å¡è™Ÿ (sn_code)</th>
                                            <th style="width: 20%; text-align: center;">ç‹€æ…‹</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in coupon_list %}
                                        <tr class="code-row">
                                            <td class="text-center">
                                                <strong>#{{ item.sequence }}</strong>
                                            </td>
                                            <td>
                                                <input type="hidden" name="coupon_id_{{ item.coupon.id }}" value="{{ item.coupon.id }}">
                                                <input 
                                                    type="text" 
                                                    name="sn_code_{{ item.coupon.id }}" 
                                                    value="{{ item.sn_code }}"
                                                    class="form-control code-input"
                                                    placeholder="è«‹ä½¿ç”¨æƒææ§æƒæå¡è™Ÿ..."
                                                    data-sequence="{{ item.sequence }}"
                                                    data-filled="{{ item.has_code|yesno:'true,false' }}"
                                                    {% if not is_headquarter %}readonly{% endif %}
                                                >
                                            </td>
                                            <td class="text-center">
                                                <span class="status-badge">
                                                    {% if item.has_code %}
                                                    <span class="filled-badge">
                                                        <i class="ti ti-check"></i> å·²å¡«å¯«
                                                    </span>
                                                    {% else %}
                                                    <span class="empty-badge">
                                                        <i class="ti ti-alert-circle"></i> æœªå¡«å¯«
                                                    </span>
                                                    {% endif %}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            {% if is_headquarter %}
                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <a href="{% url 'business:order_product_detail' order_id=order_product.order.id product_id=order_product.id %}" 
                                   class="btn btn-outline-secondary">
                                    <i class="ti ti-arrow-left"></i> å–æ¶ˆ
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="ti ti-device-floppy"></i> å„²å­˜å¡è™Ÿ
                                </button>
                            </div>
                            {% else %}
                            <div class="alert alert-info mb-0">
                                <i class="ti ti-info-circle"></i>
                                åªæœ‰ç¸½å…¬å¸ç®¡ç†å“¡å¯ä»¥ç·¨è¼¯å¡è™Ÿ
                            </div>
                            {% endif %}
                        </form>
                    </div>
                </div>

                <!-- ä½¿ç”¨èªªæ˜ -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-info-circle"></i> ä½¿ç”¨èªªæ˜
                        </h3>
                    </div>
                    <div class="card-body">
                        <ol class="mb-0">
                            <li>æ¯å¼µå¯¦é«”ç©ºå¡éƒ½æœ‰ä¸€å€‹å”¯ä¸€çš„å¡è™Ÿï¼ˆsn_codeï¼‰</li>
                            <li><strong>ä½¿ç”¨æƒææ§æƒæå¡è™Ÿï¼Œæœƒè‡ªå‹•é€£çºŒå¡«å…¥æœªå¡«å¯«çš„æ¬„ä½</strong></li>
                            <li>å·²å¡«å¯«çš„å¡è™Ÿæœƒè¢«è·³éï¼Œé™¤éç”¨æ»‘é¼ é»æ“Šè©²æ¬„ä½é€²è¡Œä¿®æ”¹</li>
                            <li>å¡«å¯«å®Œæˆå¾Œï¼Œé»æ“Šã€Œå„²å­˜å¡è™Ÿã€é€²è¡Œå„²å­˜</li>
                            <li>å„²å­˜å¡è™Ÿä¸æœƒç«‹å³æ¨é€åˆ° API é€²è¡Œå•Ÿç”¨</li>
                            <li>éœ€è¦åœ¨è¨‚å–®ç®¡ç†é é¢æ‰‹å‹•è§¸ç™¼ã€Œæ‰¹é‡å…Œæ›ã€åŠŸèƒ½</li>
                            <li>ç³»çµ±æœƒè‡ªå‹•æª¢æŸ¥å¡è™Ÿæ˜¯å¦é‡è¤‡ï¼Œé‡è¤‡çš„å¡è™Ÿä¸æœƒè¢«å„²å­˜</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scriptcontent %}
<script>
    console.log('ğŸ“‹ RECHARGEABLE å¡è™Ÿç®¡ç†é é¢è¼‰å…¥');

    // âœ… CSV ä¸Šå‚³è™•ç†
    (function() {
        const csvUploadForm = document.getElementById('csvUploadForm');
        const csvFileInput = document.getElementById('csvFileInput');
        const downloadCsvTemplate = document.getElementById('downloadCsvTemplate');
        
        if (!csvUploadForm) return;
        
        // CSV ä¸Šå‚³
        csvUploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const file = csvFileInput.files[0];
            if (!file) {
                alert('è«‹é¸æ“‡ CSV æª”æ¡ˆ');
                return;
            }
            
            if (!file.name.endsWith('.csv')) {
                alert('è«‹ä¸Šå‚³ CSV æ ¼å¼çš„æª”æ¡ˆ');
                return;
            }
            
            // ç¢ºèªæç¤º
            if (!confirm(`ç¢ºå®šè¦åŒ¯å…¥ CSV æª”æ¡ˆ "${file.name}" å—ï¼Ÿ\n\nåŒ¯å…¥å¾Œå°‡è¦†è“‹ç¾æœ‰çš„å¡è™Ÿï¼ˆæŒ‰é †åºï¼‰ã€‚`)) {
                return;
            }
            
            // å»ºç«‹ FormData
            const formData = new FormData(this);
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalBtnHtml = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>åŒ¯å…¥ä¸­...';
            
            // ç™¼é€ AJAX è«‹æ±‚
            fetch('{% url "business:import_rechargeable_codes_csv" order_id=order_product.order.id product_id=order_product.id %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`âœ… ${data.message}\n\nâ€¢ ç¸½è¨ˆï¼š${data.total_codes} å€‹å¡è™Ÿ\nâ€¢ æ›´æ–°ï¼š${data.updated_count} ç­†`);
                    // é‡æ–°è¼‰å…¥é é¢ä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„è³‡æ–™
                    window.location.reload();
                } else {
                    alert(`âŒ åŒ¯å…¥å¤±æ•—ï¼š${data.error}`);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnHtml;
                }
            })
            .catch(error => {
                console.error('CSV ä¸Šå‚³å¤±æ•—ï¼š', error);
                alert(`âŒ åŒ¯å…¥å¤±æ•—ï¼š${error.message || 'ç¶²è·¯éŒ¯èª¤'}`);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnHtml;
            });
        });
        
        // âœ… ä¸‹è¼‰ CSV ç¯„æœ¬
        downloadCsvTemplate.addEventListener('click', function(e) {
            e.preventDefault();
            
            // ç”Ÿæˆ CSV ç¯„æœ¬å…§å®¹
            let csvContent = 'åºè™Ÿ,å¡è™Ÿ\n';
            const totalCodes = {{ total_codes }};
            
            for (let i = 1; i <= Math.min(totalCodes, 5); i++) {
                csvContent += `${i},ç¯„ä¾‹å¡è™Ÿ${i.toString().padStart(3, '0')}\n`;
            }
            
            // å¦‚æœè¶…é 5 å¼µï¼Œé¡¯ç¤ºçœç•¥ç¬¦è™Ÿ
            if (totalCodes > 5) {
                csvContent += `...\n`;
                csvContent += `${totalCodes},ç¯„ä¾‹å¡è™Ÿ${totalCodes.toString().padStart(3, '0')}\n`;
            }
            
            // å»ºç«‹ä¸‹è¼‰é€£çµ
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'rechargeable_codes_template.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('âœ… CSV ç¯„æœ¬å·²ä¸‹è¼‰');
        });
    })();
    
    // âœ… æƒææ§è‡ªå‹•å¡«å…¥åŠŸèƒ½ï¼ˆå„ªåŒ–ç‰ˆï¼‰
    (function() {
        'use strict';
        
        // ç²å–æ‰€æœ‰å¡è™Ÿè¼¸å…¥æ¡†
        const codeInputs = document.querySelectorAll('.code-input:not([readonly])');
        
        if (codeInputs.length === 0) {
            console.log('æ²’æœ‰å¯ç·¨è¼¯çš„å¡è™Ÿè¼¸å…¥æ¡†ï¼ˆåªè®€æ¨¡å¼ï¼‰');
            return;
        }
        
        // ç•¶å‰èšç„¦çš„è¼¸å…¥æ¡†ç´¢å¼•
        let currentFocusIndex = -1;
        
        // æ˜¯å¦ç‚ºæ‰‹å‹•è¼¸å…¥æ¨¡å¼
        let isManualInput = false;
        
        // è¼¸å…¥è¨ˆæ™‚å™¨ï¼ˆç”¨æ–¼æª¢æ¸¬æƒææ§ï¼‰
        let inputTimer = null;
        
        // ä¸Šæ¬¡è¼¸å…¥æ™‚é–“
        let lastInputTime = 0;
        
        // æƒææ§è¼¸å…¥é–¾å€¼ï¼ˆæ¯«ç§’ï¼‰- æƒææ§é€šå¸¸åœ¨ 50ms å…§å®Œæˆæ•´å€‹è¼¸å…¥
        const SCAN_THRESHOLD = 100;
        
        /**
         * å°‹æ‰¾ä¸‹ä¸€å€‹æœªå¡«å¯«çš„è¼¸å…¥æ¡†
         */
        function findNextEmptyInput() {
            for (let i = 0; i < codeInputs.length; i++) {
                const input = codeInputs[i];
                if (!input.value.trim()) {
                    return i;
                }
            }
            return -1; // æ‰€æœ‰è¼¸å…¥æ¡†éƒ½å·²å¡«å¯«
        }
        
        /**
         * èšç„¦åˆ°æŒ‡å®šè¼¸å…¥æ¡†ä¸¦æ·»åŠ è¦–è¦ºæ•ˆæœ
         */
        function focusInput(index) {
            if (index < 0 || index >= codeInputs.length) {
                console.log('æ‰€æœ‰å¡è™Ÿå·²å¡«å¯«å®Œæˆ');
                return;
            }
            
            // ç§»é™¤æ‰€æœ‰è¼¸å…¥æ¡†çš„ active æ¨£å¼
            codeInputs.forEach(input => {
                input.classList.remove('active-scan');
            });
            
            // èšç„¦åˆ°ç›®æ¨™è¼¸å…¥æ¡†
            const targetInput = codeInputs[index];
            targetInput.focus();
            targetInput.classList.add('active-scan');
            
            // æ»¾å‹•åˆ°å¯è¦–å€åŸŸ
            targetInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            currentFocusIndex = index;
            
            console.log(`âœ… èšç„¦åˆ°ç¬¬ ${index + 1} å€‹å¡è™Ÿè¼¸å…¥æ¡†ï¼ˆåºè™Ÿ ${targetInput.dataset.sequence}ï¼‰`);
        }
        
        /**
         * æ›´æ–°ç‹€æ…‹å¾½ç« 
         */
        function updateStatusBadge(input) {
            const row = input.closest('tr');
            const statusBadge = row.querySelector('.status-badge');
            
            if (input.value.trim()) {
                statusBadge.innerHTML = `
                    <span class="filled-badge">
                        <i class="ti ti-check"></i> å·²å¡«å¯«
                    </span>
                `;
            } else {
                statusBadge.innerHTML = `
                    <span class="empty-badge">
                        <i class="ti ti-alert-circle"></i> æœªå¡«å¯«
                    </span>
                `;
            }
        }
        
        /**
         * åˆå§‹åŒ–ï¼šèšç„¦åˆ°ç¬¬ä¸€å€‹æœªå¡«å¯«çš„è¼¸å…¥æ¡†
         */
        function initAutoFocus() {
            const firstEmptyIndex = findNextEmptyInput();
            if (firstEmptyIndex !== -1) {
                focusInput(firstEmptyIndex);
            } else {
                console.log('æ‰€æœ‰å¡è™Ÿå·²å¡«å¯«å®Œæˆ');
            }
        }
        
        /**
         * æª¢æ¸¬æ˜¯å¦ç‚ºæƒææ§è¼¸å…¥
         * åŸç†ï¼šæƒææ§æœƒåœ¨æ¥µçŸ­æ™‚é–“å…§é€£çºŒè§¸ç™¼ input äº‹ä»¶
         */
        function isScannerInput() {
            const currentTime = Date.now();
            const timeDiff = currentTime - lastInputTime;
            lastInputTime = currentTime;
            
            // å¦‚æœå…©æ¬¡è¼¸å…¥é–“éš”å°æ–¼é–¾å€¼ï¼Œåˆ¤å®šç‚ºæƒææ§
            return timeDiff < SCAN_THRESHOLD;
        }
        
        // âœ… ç›£è½æ‰€æœ‰è¼¸å…¥æ¡†çš„äº‹ä»¶
        codeInputs.forEach((input, index) => {
            
            // âœ… keydown äº‹ä»¶ï¼šæª¢æ¸¬éµç›¤è¼¸å…¥ï¼ˆæ‰‹å‹•è¼¸å…¥çš„æ¨™èªŒï¼‰
            input.addEventListener('keydown', function(e) {
                // æ’é™¤åŠŸèƒ½éµï¼ˆTab, Enter, Backspace ç­‰ï¼‰
                if (['Tab', 'Enter', 'Escape', 'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                    // Enter éµï¼šæ‰‹å‹•è·³è½‰åˆ°ä¸‹ä¸€å€‹æœªå¡«å¯«çš„æ¬„ä½
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        isManualInput = false; // é‡ç½®æ‰‹å‹•è¼¸å…¥æ¨™è¨˜
                        const nextEmptyIndex = findNextEmptyInput();
                        if (nextEmptyIndex !== -1) {
                            focusInput(nextEmptyIndex);
                        }
                    }
                    return;
                }
                
                // æª¢æ¸¬åˆ°éµç›¤è¼¸å…¥ï¼Œè¨­å®šç‚ºæ‰‹å‹•è¼¸å…¥æ¨¡å¼
                isManualInput = true;
                console.log('ğŸ–ï¸ æª¢æ¸¬åˆ°æ‰‹å‹•éµç›¤è¼¸å…¥');
            });
            
            // âœ… input äº‹ä»¶ï¼šè™•ç†è¼¸å…¥å…§å®¹
            input.addEventListener('input', function(e) {
                const value = this.value.trim();
                
                console.log(`ğŸ“ è¼¸å…¥æ¡† ${index + 1} å…§å®¹è®Šæ›´ï¼š${value}`);
                
                // æ›´æ–°ç‹€æ…‹å¾½ç« 
                updateStatusBadge(this);
                
                // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
                if (inputTimer) {
                    clearTimeout(inputTimer);
                }
                
                // å¦‚æœæ˜¯æ‰‹å‹•è¼¸å…¥æ¨¡å¼ï¼Œä¸è‡ªå‹•è·³è½‰
                if (isManualInput) {
                    console.log('âœ‹ æ‰‹å‹•è¼¸å…¥æ¨¡å¼ï¼Œä¸è‡ªå‹•è·³è½‰');
                    
                    // è¨­å®šè¨ˆæ™‚å™¨ï¼šå¦‚æœ 1 ç§’å…§æ²’æœ‰æ–°çš„è¼¸å…¥ï¼Œé‡ç½®æ‰‹å‹•è¼¸å…¥æ¨¡å¼
                    inputTimer = setTimeout(() => {
                        isManualInput = false;
                        console.log('â° æ‰‹å‹•è¼¸å…¥æ¨¡å¼å·²é‡ç½®');
                    }, 1000);
                    
                    return;
                }
                
                // æª¢æ¸¬æ˜¯å¦ç‚ºæƒææ§è¼¸å…¥
                const isScanner = isScannerInput();
                
                // å¦‚æœè¼¸å…¥äº†å…§å®¹ï¼Œä¸”åˆ¤å®šç‚ºæƒææ§
                if (value && isScanner) {
                    console.log(`ğŸ”« æƒææ§è¼¸å…¥ï¼š${value}`);
                    
                    // å»¶é²è·³è½‰ï¼ˆçµ¦æƒææ§ç•™å‡ºæ™‚é–“å®Œæˆæ•´å€‹å¡è™Ÿçš„è¼¸å…¥ï¼‰
                    inputTimer = setTimeout(() => {
                        const nextEmptyIndex = findNextEmptyInput();
                        if (nextEmptyIndex !== -1) {
                            focusInput(nextEmptyIndex);
                        } else {
                            console.log('ğŸ‰ æ‰€æœ‰å¡è™Ÿå·²å¡«å¯«å®Œæˆï¼');
                            // ç§»é™¤æ‰€æœ‰ active æ¨£å¼
                            codeInputs.forEach(inp => inp.classList.remove('active-scan'));
                        }
                    }, 150); // 150ms å»¶é²ï¼Œç¢ºä¿æƒææ§å®Œæˆè¼¸å…¥
                }
            });
            
            // âœ… focus äº‹ä»¶ï¼šç”¨æˆ¶é»æ“Šè¼¸å…¥æ¡†
            input.addEventListener('focus', function(e) {
                // ç§»é™¤æ‰€æœ‰è¼¸å…¥æ¡†çš„ active æ¨£å¼
                codeInputs.forEach(inp => inp.classList.remove('active-scan'));
                
                // æ·»åŠ ç•¶å‰è¼¸å…¥æ¡†çš„ active æ¨£å¼
                this.classList.add('active-scan');
                
                currentFocusIndex = index;
                
                console.log(`ğŸ‘† èšç„¦åˆ°è¼¸å…¥æ¡† ${index + 1}`);
                
                // å¦‚æœæ˜¯é€šéæ»‘é¼ é»æ“Šèšç„¦ï¼Œè¨­å®šç‚ºæ‰‹å‹•è¼¸å…¥æ¨¡å¼
                // é€™æ¨£å¯ä»¥é˜²æ­¢é»æ“Šå¾Œç«‹å³è·³è½‰
                isManualInput = true;
                
                // 200ms å¾Œé‡ç½®ï¼ˆå¦‚æœæ˜¯æƒææ§è‡ªå‹•èšç„¦ï¼Œæœƒåœ¨é€™ä¹‹å‰å°±é–‹å§‹è¼¸å…¥ï¼‰
                setTimeout(() => {
                    if (this.value === '') {
                        // å¦‚æœèšç„¦å¾Œ 200ms å…§æ²’æœ‰è¼¸å…¥ï¼Œå¯èƒ½æ˜¯æº–å‚™æ‰‹å‹•è¼¸å…¥
                        isManualInput = true;
                    }
                }, 200);
            });
            
            // âœ… blur äº‹ä»¶ï¼šå¤±å»ç„¦é»
            input.addEventListener('blur', function(e) {
                // å»¶é²é‡ç½®æ‰‹å‹•è¼¸å…¥æ¨¡å¼
                setTimeout(() => {
                    isManualInput = false;
                    console.log('ğŸ‘‹ å¤±å»ç„¦é»ï¼Œæ‰‹å‹•è¼¸å…¥æ¨¡å¼å·²é‡ç½®');
                }, 300);
            });
            
            // âœ… paste äº‹ä»¶ï¼šè™•ç†ç²˜è²¼
            input.addEventListener('paste', function(e) {
                console.log('ğŸ“‹ æª¢æ¸¬åˆ°ç²˜è²¼æ“ä½œ');
                isManualInput = false; // ç²˜è²¼è¦–ç‚ºä¸€æ¬¡æ€§è¼¸å…¥ï¼Œå¯ä»¥è‡ªå‹•è·³è½‰
                
                setTimeout(() => {
                    const nextEmptyIndex = findNextEmptyInput();
                    if (nextEmptyIndex !== -1) {
                        focusInput(nextEmptyIndex);
                    }
                }, 100);
            });
        });
        
        // âœ… é é¢è¼‰å…¥å¾Œè‡ªå‹•èšç„¦åˆ°ç¬¬ä¸€å€‹æœªå¡«å¯«çš„è¼¸å…¥æ¡†
        window.addEventListener('load', function() {
            setTimeout(() => {
                initAutoFocus();
                // åˆå§‹åŒ–æ™‚é‡ç½®æ‰‹å‹•è¼¸å…¥æ¨¡å¼
                isManualInput = false;
            }, 500); // å»¶é² 500msï¼Œç¢ºä¿é é¢å®Œå…¨è¼‰å…¥
        });
        
        console.log('âœ… æƒææ§è‡ªå‹•å¡«å…¥åŠŸèƒ½å·²å•Ÿç”¨ï¼ˆå„ªåŒ–ç‰ˆï¼‰');
        console.log(`ğŸ“Š å…± ${codeInputs.length} å€‹å¯ç·¨è¼¯çš„å¡è™Ÿè¼¸å…¥æ¡†`);
        console.log(`âš™ï¸ æƒææ§æª¢æ¸¬é–¾å€¼ï¼š${SCAN_THRESHOLD}ms`);
    })();
    
    // âœ… è¡¨å–®æäº¤é©—è­‰
    document.getElementById('codesForm').addEventListener('submit', function(e) {
        const inputs = document.querySelectorAll('.code-input:not([readonly])');
        let hasEmpty = false;
        let emptyCount = 0;
        
        inputs.forEach(input => {
            if (!input.value.trim()) {
                hasEmpty = true;
                emptyCount++;
            }
        });
        
        if (hasEmpty) {
            const confirmMsg = `æœ‰ ${emptyCount} å€‹å¡è™Ÿæœªå¡«å¯«ï¼Œç¢ºå®šè¦å„²å­˜å—ï¼Ÿ\n\næœªå¡«å¯«çš„å¡è™Ÿå¯ä»¥ç¨å¾Œå†è£œå¡«ã€‚`;
            if (!confirm(confirmMsg)) {
                e.preventDefault();
                return false;
            }
        }
        
        // ç¦ç”¨æäº¤æŒ‰éˆ•ï¼Œé¿å…é‡è¤‡æäº¤
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>å„²å­˜ä¸­...';
    });
</script>
{% endblock %}