{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}<title>{{ form_title }} - DB3C ERP</title>{% endblock %}

{% block css %}
<style>
    .form-container {
        max-width: 800px;
        margin: 0 auto;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 16px rgba(0,0,0,0.1);
        padding: 40px;
    }
    
    .form-section {
        margin-bottom: 30px;
        padding-bottom: 30px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .form-section:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    
    .form-section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #495057;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .form-section-title i {
        color: #0d6efd;
    }
    
    /* 表單控制元件 */
    .form-control, .form-select, textarea {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus, textarea:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }
    
    /* 必填標記 */
    .required-mark {
        color: #dc3545;
        margin-left: 3px;
        font-weight: 700;
    }
    
    /* 幫助文字 */
    .form-text {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 5px;
    }
    
    /* 錯誤訊息 */
    .error-message {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 5px;
    }
    
    /* 按鈕區域 */
    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #e9ecef;
    }
    
    .btn {
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
        background: #6c757d;
        border: none;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
    }
    
    /* 金額預覽 */
    .amount-preview {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 10px;
        display: none;
    }
    
    .amount-preview.show {
        display: block;
    }
    
    .amount-preview-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 5px;
    }
    
    .amount-preview-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-xl">
        <!-- 頁面標題 -->
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h2 class="page-title">
                        <i class="fa fa-money"></i> {{ form_title }}
                    </h2>
                    <div class="text-muted">
                        {% if object %}
                            編輯支出記錄 ID: {{ object.id }}
                        {% else %}
                            建立新的支出記錄
                        {% endif %}
                    </div>
                </div>
                <div class="col-auto">
                    <a href="{% url 'business:expense_list' %}" class="btn btn-secondary">
                        <i class="fa fa-arrow-left"></i> 返回列表
                    </a>
                </div>
            </div>
        </div>

        <!-- 表單容器 -->
        <div class="form-container">
            <form method="post" id="expenseForm">
                {% csrf_token %}
                
                <!-- 基本資訊 -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fa fa-info-circle"></i>
                        基本資訊
                    </div>
                    
                    <div class="row">
                        <!-- 名稱 -->
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label">
                                名稱<span class="required-mark">*</span>
                            </label>
                            {{ form.name|add_class:"form-control" }}
                            {% if form.name.errors %}
                                <div class="error-message">{{ form.name.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">支出項目的名稱或描述</div>
                        </div>
                        
                        <!-- 日期 -->
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.date.id_for_label }}" class="form-label">
                                日期
                            </label>
                            {{ form.date|add_class:"form-control"|attr:"type:date" }}
                            {% if form.date.errors %}
                                <div class="error-message">{{ form.date.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">支出發生日期</div>
                        </div>
                    </div>
                </div>
                
                <!-- 金額與項目 -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fa fa-dollar"></i>
                        金額與項目
                    </div>
                    
                    <div class="row">
                        <!-- 金額 -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.amount.id_for_label }}" class="form-label">
                                支出金額<span class="required-mark">*</span>
                            </label>
                            {{ form.amount|add_class:"form-control"|attr:"placeholder:請輸入金額"|attr:"min:0"|attr:"step:1" }}
                            {% if form.amount.errors %}
                                <div class="error-message">{{ form.amount.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">請輸入整數金額（不含小數）</div>
                            
                            <!-- 金額預覽 -->
                            <div class="amount-preview" id="amountPreview">
                                <div class="amount-preview-label">支出金額：</div>
                                <div class="amount-preview-value" id="amountPreviewValue">$0</div>
                            </div>
                        </div>
                        
                        <!-- 支出項目 -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.item.id_for_label }}" class="form-label">
                                支出項目<span class="required-mark">*</span>
                            </label>
                            {{ form.item|add_class:"form-select" }}
                            {% if form.item.errors %}
                                <div class="error-message">{{ form.item.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">選擇支出類別</div>
                        </div>
                    </div>
                </div>
                
                <!-- 備註 -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fa fa-comment"></i>
                        備註說明
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.remark.id_for_label }}" class="form-label">
                            備註
                        </label>
                        {{ form.remark|add_class:"form-control"|attr:"rows:4"|attr:"placeholder:請輸入備註說明（選填）" }}
                        {% if form.remark.errors %}
                            <div class="error-message">{{ form.remark.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text">其他補充說明或細節</div>
                    </div>
                </div>
                
                <!-- 操作按鈕 -->
                <div class="form-actions">
                    <a href="{% url 'business:expense_list' %}" class="btn btn-secondary">
                        <i class="fa fa-times"></i> 取消
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-save"></i> {{ submit_text }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
$(document).ready(function() {
    // 金額即時預覽
    $('#{{ form.amount.id_for_label }}').on('input', function() {
        const amount = parseFloat($(this).val()) || 0;
        const preview = $('#amountPreview');
        const previewValue = $('#amountPreviewValue');
        
        if (amount > 0) {
            previewValue.text('$' + amount.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }));
            preview.addClass('show');
        } else {
            preview.removeClass('show');
        }
    });
    
    // 自動設定今天日期（如果是新增且沒有預設值）
    {% if not object %}
    const dateInput = $('#{{ form.date.id_for_label }}');
    if (!dateInput.val()) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.val(today);
    }
    {% endif %}
    
    // 表單驗證
    $('#expenseForm').on('submit', function(e) {
        const name = $('#{{ form.name.id_for_label }}').val().trim();
        const amount = parseFloat($('#{{ form.amount.id_for_label }}').val());
        const item = $('#{{ form.item.id_for_label }}').val();
        
        if (!name) {
            e.preventDefault();
            alert('請輸入名稱');
            $('#{{ form.name.id_for_label }}').focus();
            return false;
        }
        
        if (!amount || amount <= 0) {
            e.preventDefault();
            alert('請輸入有效的支出金額');
            $('#{{ form.amount.id_for_label }}').focus();
            return false;
        }
        
        if (!item) {
            e.preventDefault();
            alert('請選擇支出項目');
            $('#{{ form.item.id_for_label }}').focus();
            return false;
        }
        
        return true;
    });
    
    // 觸發初始預覽（編輯模式）
    {% if object %}
    $('#{{ form.amount.id_for_label }}').trigger('input');
    {% endif %}
});
</script>
{% endblock %}