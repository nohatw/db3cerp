{% extends 'base_auth.html' %}
{% load static %}
{% load humanize %}
{% load currency %}

{% block title %}
<title>收據 - {{ receipt.receipt_number }} - DB3C ERP</title>{% endblock %}

{% block css %}
<style>
    .receipt-container {
        width: 800px;
        min-height: 520px;
        margin: 0 auto;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
        background-image: url("{% static 'assets/images/receipt.jpg' %}");
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        position: relative;
    }
    
    /* 固定位置的資訊欄位 */
    .receipt-info-data {
        font-size: 16px;
        position: absolute;
    }
    .data-year {
        top: 80px;
        left: 325px;
    }
    .data-month {
        top: 80px;
        left: 400px;
    }
    .data-day {
        top: 80px;
        left: 450px;
    }
    .receipt-info-number {
        font-size: 19px;
        position: absolute;
        top: 120px;
        right: 30px;
    }
    .receipt-info-title {
        font-size: 18px;
        position: absolute;
        top: 120px;
        left: 80px;
        width: 600px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* 產品列表區域（改為動態列表） */
    .receipt-products-container {
        position: absolute;
        top: 230px;
        left: 15px;
        right: 15px;
        width: calc(100% - 160px);
    }
    
    .receipt-info-product {
        display: flex;
        justify-content:flex-start;
        align-items: center ;
        font-size: 13px;
        line-height: 1.5;
        margin-bottom: 3px; /* 每個產品之間的間距 */
        padding: 3px 0;
    }
    
    .receipt-info-product-name {
        flex: 1;
        width: 280px;
        max-width: 280px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding-right: 10px;
        margin-right: 100px;
    }
    
    .receipt-info-product-quantity {
        width: 30px;
        margin-right: 30px;
    }
    
    .receipt-info-product-unitprice {
        width: 50px;
        margin-right: 30px;
    }
    
    .receipt-info-product-subtotal {
        width: 50px;
        padding-right: 10px;
    }
    .receipt-info-total {
        position: absolute;
        top: 390px;
        right: 210px;
        font-size: 16px;
        font-weight: bold;
    }
    
    .receipt-info-product-remark {
        position: absolute;
        font-size: 11px;
        width: 120px;
        white-space: nowrap;
        text-overflow: ellipsis;
        top:220px;
        right:40px;
    }

    /* ✅ 新增：大寫中文金額顯示區域 */
    .receipt-amount-chinese {
        position: absolute;
        bottom: 100px;
        left: 50px;
        font-size: 16px;
        font-weight: bold;
    }
    
    /* 每個數字位置 */
    .amount-digit {
        display: inline-block;
        min-width: 24px;
        text-align: center;
        margin: 0 2px;
    }
    
    .amount-unit {
        display: inline-block;
        font-size: 14px;
        margin: 0 1px;
    }
    
    /* 特定位置的數字（可根據收據模板調整） */
    .digit-qian-wan {
        position: absolute;
        top: 425px;
        left: 140px;
        font-size: 16px;
    }
    
    .digit-bai-wan {
        position: absolute;
        top: 425px;
        left: 200px;
        font-size: 16px;
    }
    
    .digit-shi-wan {
        position: absolute;
        top: 425px;
        left: 260px;
        font-size: 16px;
    }
    
    .digit-wan {
        position: absolute;
        top: 425px;
        left: 320px;
        font-size: 16px;
    }
    
    .digit-qian {
        position: absolute;
        top: 425px;
        left: 390px;
        font-size: 16px;
    }
    
    .digit-bai {
        position: absolute;
        top: 425px;
        left: 450px;
        font-size: 16px;
    }
    
    .digit-shi {
        position: absolute;
        top: 425px;
        left: 500px;
        font-size: 16px;
    }
    
    .digit-yuan {
        position: absolute;
        top: 425px;
        left: 560px;
        font-size: 16px;
    }
    
    /* 完整文字版本（可選） */
    .amount-full-text {
        position: absolute;
        top: 450px;
        left: 100px;
        font-size: 14px;
    }
    
    /* 列印時的優化 */
    @media print {
        .receipt-container {
            border: none;
            box-shadow: none;
        }
        
        .receipt-info-product {
            page-break-inside: avoid;
        }
    }
</style>
{% endblock %}

{% block print %}
<div class="page-body">
    <div class="receipt-container">
        <!-- 固定位置的資訊 -->
        <div class="receipt-info-data data-year">{{ receipt.date|date:"Y" }}</div>
        <div class="receipt-info-data data-month">{{ receipt.date|date:"m" }}</div>
        <div class="receipt-info-data data-day">{{ receipt.date|date:"d" }}</div>
        <div class="receipt-info-number">{{ receipt.receipt_number }}</div>

        {% if receipt.taxid %}
            <!-- 有統編：顯示買受人名稱 + 統編 -->
            <div class="receipt-info-title">{{ receipt.receipt_to|default:"（無抬頭）" }}</div>
            <div style="position: absolute; top: 150px; left: 80px; font-size: 16px;">
                統編：{{ receipt.taxid }}
            </div>
        {% else %}
            <!-- 無統編：顯示「零售」 -->
            <div class="receipt-info-title">零售</div>
        {% endif %}
        <!-- 產品列表區域（改為依序排列） -->
        <div class="receipt-products-container">
            {% for item in receipt.items.all %}
                <div class="receipt-info-product">
                    <div class="receipt-info-product-name" title="{{ item.product_name }}">
                        {{ item.product_name }}
                    </div>
                    <div class="receipt-info-product-quantity">
                        {{ item.quantity }}
                    </div>
                    <div class="receipt-info-product-unitprice">
                        {{ item.unit_price|currency }}
                    </div>
                    <div class="receipt-info-product-subtotal">
                        ${{ item.subtotal|currency }}
                    </div>
                </div>
            {% empty %}
                <div class="receipt-info-product" style="color: #999; text-align: center;">
                    （無產品明細）
                </div>
            {% endfor %}
        </div>
        <!-- 總計金額 -->
        <div class="receipt-info-total">${{ total_amount_number|currency }}</div>
        
        <!-- 備註 -->
        <div class="receipt-info-product-remark" title="{{ receipt.remark }}">
            {{ receipt.remark }}
        </div>

        <!-- 大寫中文金額顯示 -->
        <!-- 方式一：每個數字獨立定位（適合精確對齊收據模板） -->
        <div class="digit-qian-wan">{{ chinese_amount.qian_wan }}</div>
        <div class="digit-bai-wan">{{ chinese_amount.bai_wan }}</div>
        <div class="digit-shi-wan">{{ chinese_amount.shi_wan }}</div>
        <div class="digit-wan">{{ chinese_amount.wan }}</div>
        <div class="digit-qian">{{ chinese_amount.qian }}</div>
        <div class="digit-bai">{{ chinese_amount.bai }}</div>
        <div class="digit-shi">{{ chinese_amount.shi }}</div>
        <div class="digit-yuan">{{ chinese_amount.yuan }}</div>
       
        
        <!-- 方式二：完整文字（可選） -->
        <!-- <div class="amount-full-text">
            總計新台幣：{{ chinese_amount.full_text }}
        </div> -->
        
        <!-- Debug 資訊（開發時使用，正式環境可刪除） -->
     
        <!-- <div style="position: absolute; bottom: 20px; left: 20px; font-size: 12px; color: #666;">
            原始金額：${{ total_amount_number|currency }}<br>
            中文金額：{{ chinese_amount.full_text }}
        </div>
  -->
    </div>
</div>
{% endblock %}