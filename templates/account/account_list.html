{% extends 'base.html' %}
{% load static %} 
{% load humanize %}
{% load currency %}
{% block css %}
<!-- Plugins css start-->
<style>
    .filter-section {
        margin-bottom: 20px;
        padding: 15px;
        background-color: none;
        border-radius: 5px;
    }
    .filter-title {
        font-weight: 600;
        margin-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 8px;
    }
    @media (max-width: 767.98px) {
        .client-card {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .client-card .card-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
        }
        .client-info {
            font-size: 0.9rem;
        }
        .balance-badge .badge {
            font-size: 0.9rem;
        }
        .pagination {
            justify-content: center;
        }
        .total-summary {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 16px;
            text-align: center;
        }
    }
</style>
<!-- Plugins css Ends-->
{% endblock %}

{% block title %}
<title>使用者列表</title>
{% endblock %}

{% block content %}

<div class="page-body">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header pb-0 mb-0">
                        <div class="d-flex justify-content-between">
                            <h3>使用者列表</h3>
                            <div>
                                <a href="" class="btn btn-sm btn-primary disabled"><i class="fa fa-plus"></i> 新增使用者</a>
                            </div>
                        </div>
                   
                    </div>
                    <div class="card-body pt-0">

                        <!-- 過濾區塊 -->
                        <div class="filter-section">
                            <div class="filter-title">
                                <i class="fa fa-filter"></i> 篩選條件
                            </div>
                            <form method="get" action="" id="filterForm">
                                <div class="row g-3">
                                    <!-- 搜尋關鍵字 -->
                                    <div class="col-md-6">
                                        <span class="form-label">搜尋</span>
                                        <input type="text" name="q" class="form-control" placeholder="姓名、帳號、手機、信箱" value="{{ search_query }}">
                                    </div>
                                   
                                    <!-- 用戶狀態 -->
                                    <div class="col-md-3">
                                        <span class="form-label">用戶狀態</span>
                                        <select name="status" class="form-select">
                                            <option value="">全部狀態</option>
                                            {% for value, label in account_statuses %}
                                                <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    {% if is_headquarter_admin %}
                                    <!-- 用戶角色 -->
                                    <div class="col-md-3">
                                        <span class="form-label">用戶角色</span>
                                        <select name="role" class="form-select">
                                            <option value="">全部角色</option>
                                            {% for value, label in account_roles %}
                                                <option value="{{ value }}" {% if selected_role == value %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- 操作按鈕 -->
                                    <div class="col-md-4 d-flex align-items-end">
                                        <button type="submit" class="btn btn-sm btn-primary me-2">
                                            <i class="fa fa-search"></i> 搜尋
                                        </button>
                                        <a href="{% url 'accounts:account_list' %}" class="btn btn-sm btn-secondary">
                                            <i class="fa fa-refresh"></i> 重置
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>

                        
                        <!-- Desktop Table View (在手機上隱藏) -->
                        <div class="table-responsive d-none d-md-block">
                            <table class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>帳號</th>
                                        <th>角色</th>
                                        <th>狀態</th>
                                        <th>儲值</th>
                                        <th>上級</th>
                                        <th>動作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for account in accounts %}
                                        <tr class="{% if account.status == 'INACTIVE' or account.status == 'ARCHIVED' %}table-light{% endif %}">
                                            <td>{{ account.id }}</td>
                                            <td>
                                                <a href="{% url 'accounts:account_detail' account.pk %}" class="">
                                                    {{ account.username }}
                                                    
                                                </a><br />
                                                <span>{{ account.fullname }}</span>
                                                
                                            </td>
                                            <td>
                                                
                                                {% if account.role == 'AGENT' %}
                                                <span class="badge bg-primary">
                                                    <i class="fa fa-user-tie"></i>
                                                    <span class=""> {{ account.get_role_display }}</span>
                                                </span>
                                                {% elif account.role == 'DISTRIBUTOR' %}
                                                <span class="badge bg-secondary">
                                                    <i class="fa fa-user-friends"></i>
                                                    <span> {{ account.get_role_display }}</span>
                                                </span>
                                                {% else %}
                                                <span class="badge bg-info">
                                                    <i class="fa fa-user"></i>
                                                    <span class=""> {{ account.get_role_display }}</span>
                                                </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if account.status == 'ACTIVE' %}
                                                    <span class="badge bg-success">{{ account.get_status_display }}</span>
                                                {% elif account.status == 'INACTIVE' %}
                                                    <span class="badge bg-danger">{{ account.get_status_display }}</span>
                                                {% else %}
                                                    <span class="badge bg-light">{{ account.get_status_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if account.topup_balance %}
                                                    ${{ account.topup_balance|currency }}
                                                {% else %}
                                                    <span class="text-muted">$0</span>
                                                {% endif %}
                                            </td>

                                            <td>
                                                {% if account.parent %}
                                                    {% if is_headquarter_admin or account.parent == request.user or account.parent.parent == request.user %}
                                                        <a href="{% url 'accounts:account_detail' account.parent.pk %}">
                                                            {{ account.parent.fullname|default:account.parent.username }}
                                                        </a>
                                                    {% else %}
                                                        <span class="text-muted">{{ account.parent.fullname|default:account.parent.username }}</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group">
                                                    {% if account.status == 'ACTIVE' %}
                                                        {% if is_headquarter_admin %}
                                                        <button class="btn btn-sm btn-success select-client-btn" 
                                                                data-client-id="{{ account.pk }}" 
                                                                data-client-name="{{ account.fullname|default:account.username }}">
                                                            <i class="fa fa-shopping-cart"></i> 為此客戶下單
                                                        </button>
                                                        <a href="{% url 'business:topup_create' %}?account_id={{ account.id }}" 
                                                           class="btn btn-sm btn-warning text-dark">
                                                            <i class="fa fa-wallet"></i> 儲值
                                                        </a>
                                                        {% else %}
                                                        <span class="text-muted small">僅總公司可為他人下單</span>
                                                        {% endif %}
                                                    {% elif account.status == 'INACTIVE' or account.status == 'ARCHIVED' %}
                                                        <button class="btn btn-sm btn-secondary" disabled>
                                                            <i class="fa fa-times"></i> 帳號已停用
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center py-3">沒有找到客戶記錄</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Mobile Card View (在平板/桌面隱藏) -->
                        <div class="d-md-none">
                            {% for account in accounts %}
                            <div class="card client-card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge bg-secondary">ID: {{ account.id }}</span>
                                        <a href="" class="ms-2 fw-bold text-primary">
                                            {{ account.username }}
                                        </a>
                                         <span>{{ account.fullname }}</span>
                                    </div>
                                    <div>
                                        {% if account.role == 'AGENT' %}
                                        <span class="badge bg-primary">
                                            <i class="fa fa-user-tie"></i>
                                            <span class=""> {{ account.get_role_display }}</span>
                                        </span>
                                        {% elif account.role == 'DISTRIBUTOR' %}
                                        <span class="badge bg-secondary">
                                            <i class="fa fa-user-friends"></i>
                                            <span> {{ account.get_role_display }}</span>
                                        </span>
                                        {% endif %}
                                       
                                    </div>
                                </div>
                                <div class="card-body p-3">
                                    <div class="client-info mb-3">
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <i class="fa fa-info-circle text-secondary"></i> 狀態:
                                                {% if account.status == 'ACTIVE' %}
                                                    <span class="badge bg-success">{{ account.get_status_display }}</span>
                                                {% elif account.status == 'INACTIVE' %}
                                                    <span class="badge bg-warning">{{ account.get_status_display }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ account.get_status_display }}</span>
                                                {% endif %}
                                            </div>
                                            <div class="col-6">
                                                <i class="fa fa-wallet text-secondary"></i> 
                                                儲值: 
                                                {% if account.topup_balance %}
                                                    ${{ account.topup_balance|currency }}
                                                {% else %}
                                                    <span class="text-muted">$0</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <i class="fa fa-user-tie text-secondary"></i> 上級: 
                                                {% if account.parent %}
                                                    {% if is_headquarter_admin or account.parent == request.user or account.parent.parent == request.user %}
                                                        <a href="{% url 'accounts:account_detail' account.parent.pk %}">
                                                            {{ account.parent.fullname|default:account.parent.username }}
                                                        </a>
                                                    {% else %}
                                                        <span class="text-muted">{{ account.parent.fullname|default:account.parent.username }}</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end">
                                        {% if is_headquarter_admin %}
                                        <button class="btn btn-sm btn-success select-client-btn me-2" 
                                                data-client-id="{{ account.pk }}" 
                                                data-client-name="{{ account.fullname|default:account.username }}">
                                            <i class="fa fa-shopping-cart"></i> 為此客戶下單
                                        </button>
                                        <a href="{% url 'business:topup_create' %}?account_id={{ account.id }}" 
                                           class="btn btn-sm btn-warning text-dark">
                                            <i class="fa fa-wallet"></i> 儲值
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="alert alert-info text-center">
                                沒有找到客戶記錄
                            </div>
                            {% endfor %}
                        </div>

                        <br />
                        {% if is_paginated %}
                        <nav aria-label="Page navigation">
                            <ul class="pagination ">
                                <!-- 上一頁 -->
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if selected_status %}status={{ selected_status }}&{% endif %}{% if selected_role %}role={{ selected_role }}&{% endif %}page={{ page_obj.previous_page_number }}">&laquo; 上一頁</a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">&laquo; 上一頁</span>
                                    </li>
                                {% endif %}

                                <!-- 頁碼 -->
                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if selected_status %}status={{ selected_status }}&{% endif %}{% if selected_role %}role={{ selected_role }}&{% endif %}page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                <!-- 下一頁 -->
                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if selected_status %}status={{ selected_status }}&{% endif %}{% if selected_role %}role={{ selected_role }}&{% endif %}page={{ page_obj.next_page_number }}">下一頁 &raquo;</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}

                    </div>

                </div>

            </div>
        </div>

    </div>
</div>

{% endblock %}

{% block scriptcontent %}
<script>
    // CSRF Token
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    console.log('CSRF Token:', csrftoken);

    // 選擇客戶下單
    document.querySelectorAll('.select-client-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const clientId = this.dataset.clientId;
            const clientName = this.dataset.clientName;
            
            console.log('選擇客戶：', clientId, clientName);
            
            if (!confirm(`確定要為「${clientName}」下單嗎？\n\n選擇後會跳轉到結帳頁面。`)) {
                return;
            }
            
            // 顯示載入中
            const originalHtml = this.innerHTML;
            this.disabled = true;
            this.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 處理中...';
            
            // ✅ 構建完整的 URL
            const url = `/accounts/select-client/${clientId}/`;
            console.log('Request URL:', url);
            
            // ✅ 發送 POST 請求
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                body: JSON.stringify({})
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response Content-Type:', response.headers.get('Content-Type'));
                
                // ✅ 檢查 Content-Type 是否為 JSON
                const contentType = response.headers.get('Content-Type');
                if (!contentType || !contentType.includes('application/json')) {
                    // 如果不是 JSON，讀取為文本並顯示
                    return response.text().then(text => {
                        console.error('Response is not JSON:', text.substring(0, 200));
                        throw new Error(`伺服器返回非 JSON 格式（HTTP ${response.status}）。請檢查後端路由配置。`);
                    });
                }
                
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                
                if (data.success) {
                    // ✅ 成功後先顯示訊息
                    alert(`✓ ${data.message}\n\n即將跳轉到結帳頁面`);
                    
                    // ✅ 延遲 500ms 後跳轉
                    setTimeout(() => {
                        console.log('跳轉到結帳頁面');
                        window.location.href = '/business/checkout/';
                    }, 500);
                } else {
                    throw new Error(data.error || '選擇失敗');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ 選擇失敗：' + error.message);
                this.disabled = false;
                this.innerHTML = originalHtml;
            });
        });
    });
</script>
{% endblock %}